<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
            <div class="header-actions">
                <button onclick="window.location.href='sales.html'" class="btn btn-secondary">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
                <button id="lockBtn" class="btn btn-danger">
                    ğŸ”’ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </header>

        <!-- Add Employee Card -->
        <div class="card">
            <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h2>
            <form id="addEmployeeForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="employeeName">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
                        <input type="text" id="employeeName" name="employeeName" required placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ØŒ Ù…Ø­Ù…Ø¯ØŒ Ø¹Ù„ÙŠ">
                    </div>
                    <div class="form-group">
                        <label for="employeePassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="text" id="employeePassword" name="employeePassword" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ù…ÙˆØ¸Ù">
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                            ğŸ’¡ Ø³ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
                        </small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="employeePhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="tel" id="employeePhone" name="employeePhone" placeholder="0555123456">
                </div>
                
                <button type="submit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù â•</button>
            </form>
        </div>

        <!-- Employees List -->
        <div class="card">
            <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            <div id="employeesListContainer">
                <p class="empty-message">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</p>
            </div>
        </div>

        <!-- Employee Statistics -->
        <div class="card">
            <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
            <div id="employeeStatsContainer">
                <p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªØ§Ø­Ø©</p>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h2>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editEmployeeForm">
                <input type="hidden" id="editEmployeeId">
                <div class="form-group">
                    <label for="editEmployeeName">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <input type="text" id="editEmployeeName" required>
                </div>
                <div class="form-group">
                    <label for="editEmployeePassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <input type="text" id="editEmployeePassword" required>
                    <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                        ğŸ’¡ Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                    </small>
                </div>
                <div class="form-group">
                    <label for="editEmployeePhone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="editEmployeePhone">
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { encryptJSON, decryptJSON } from './crypto.js';
        import { formatCurrency } from './app.js';

        // Check admin authentication
        const adminPassword = sessionStorage.getItem('vault_pass');
        const userRole = sessionStorage.getItem('user_role');
        
        if (!adminPassword || userRole !== 'admin') {
            alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ±');
            window.location.href = 'index.html';
            throw new Error('Unauthorized');
        }

        // Employees storage key
        const EMPLOYEES_KEY = 'employees_data';
        
        let employees = [];
        let salesRecords = [];

        // Load employees from localStorage
        function loadEmployees() {
            try {
                const stored = localStorage.getItem(EMPLOYEES_KEY);
                if (stored) {
                    employees = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Failed to load employees:', error);
                employees = [];
            }
        }

        // Save employees to localStorage
        function saveEmployees() {
            try {
                localStorage.setItem(EMPLOYEES_KEY, JSON.stringify(employees));
            } catch (error) {
                console.error('Failed to save employees:', error);
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†');
            }
        }

        // Load sales data to get employee statistics
        async function loadSalesData() {
            try {
                const { loadVault } = await import('./store.js');
                const blob = await loadVault();
                if (blob) {
                    const decrypted = await decryptJSON(blob, adminPassword);
                    if (Array.isArray(decrypted)) {
                        salesRecords = decrypted;
                    }
                }
            } catch (error) {
                console.error('Failed to load sales data:', error);
            }
        }

        // Render employees list
        function renderEmployeesList() {
            const container = document.getElementById('employeesListContainer');
            
            if (employees.length === 0) {
                container.innerHTML = '<p class="empty-message">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'sales-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                        <th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${employees.map(emp => {
                        const addedDate = new Date(emp.addedDate);
                        const dateStr = addedDate.toLocaleDateString('ar-DZ', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        return `
                            <tr>
                                <td>
                                    <strong>ğŸ‘¤ ${emp.name}</strong>
                                </td>
                                <td>${emp.phone || '-'}</td>
                                <td>
                                    <code style="background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 4px;">
                                        ${emp.password}
                                    </code>
                                </td>
                                <td>${dateStr}</td>
                                <td>
                                    <button onclick="editEmployee('${emp.id}')" class="btn btn-sm btn-secondary" style="margin-left: 0.5rem;">
                                        âœï¸ ØªØ¹Ø¯ÙŠÙ„
                                    </button>
                                    <button onclick="deleteEmployee('${emp.id}', '${emp.name}')" class="btn btn-sm btn-danger">
                                        ğŸ—‘ï¸ Ø­Ø°Ù
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Render employee statistics
        function renderEmployeeStats() {
            const container = document.getElementById('employeeStatsContainer');
            
            if (employees.length === 0) {
                container.innerHTML = '<p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªØ§Ø­Ø©</p>';
                return;
            }

            // Calculate stats for each employee
            const employeeStats = employees.map(emp => {
                const empSales = salesRecords.filter(r => r.employee === emp.name);
                const totalSales = empSales.length;
                const totalRevenue = empSales.reduce((sum, r) => sum + r.price, 0);
                const totalGrams = empSales.reduce((sum, r) => sum + r.grams, 0);
                
                return {
                    ...emp,
                    totalSales,
                    totalRevenue,
                    totalGrams
                };
            }).sort((a, b) => b.totalRevenue - a.totalRevenue);

            container.innerHTML = `
                <div class="stats-grid">
                    ${employeeStats.map(stat => `
                        <div class="stat-card" style="border-right: 4px solid #7c3aed;">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <div class="stat-icon" style="background: #ede9fe;">ğŸ‘¤</div>
                                <div style="margin-right: 1rem;">
                                    <h3 style="margin: 0; color: #1e293b;">${stat.name}</h3>
                                    ${stat.phone ? '<small style="color: #64748b;">ğŸ“± ' + stat.phone + '</small>' : ''}
                                </div>
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #64748b;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:</span>
                                    <strong style="color: #2563eb;">${stat.totalSales}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #64748b;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                                    <strong style="color: #16a34a;">${formatCurrency(stat.totalRevenue)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: #64748b;">Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø¹:</span>
                                    <strong style="color: #f59e0b;">${stat.totalGrams.toFixed(2)} Øº</strong>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Add employee
        document.getElementById('addEmployeeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const name = formData.get('employeeName').trim();
            const password = formData.get('employeePassword').trim();
            const phone = formData.get('employeePhone').trim();
            
            // Check if name already exists
            if (employees.some(emp => emp.name === name)) {
                alert('ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸Ù Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.');
                return;
            }
            
            const newEmployee = {
                id: Date.now().toString(),
                name: name,
                password: password,
                phone: phone,
                addedDate: new Date().toISOString()
            };
            
            employees.push(newEmployee);
            saveEmployees();
            renderEmployeesList();
            renderEmployeeStats();
            
            e.target.reset();
            document.getElementById('employeeName').focus();
            
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­! âœ…\n\nØ§Ù„Ø§Ø³Ù…: ${name}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${password}\n\nÙŠÙ…ÙƒÙ† Ù„Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.`);
        });

        // Edit employee
        window.editEmployee = function(employeeId) {
            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            document.getElementById('editEmployeeId').value = employee.id;
            document.getElementById('editEmployeeName').value = employee.name;
            document.getElementById('editEmployeePassword').value = employee.password;
            document.getElementById('editEmployeePhone').value = employee.phone || '';
            
            document.getElementById('editEmployeeModal').style.display = 'flex';
        };

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editEmployeeModal').style.display = 'none';
            document.getElementById('editEmployeeForm').reset();
        };

        // Save edited employee
        document.getElementById('editEmployeeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const employeeId = document.getElementById('editEmployeeId').value;
            const newName = document.getElementById('editEmployeeName').value.trim();
            const newPassword = document.getElementById('editEmployeePassword').value.trim();
            const newPhone = document.getElementById('editEmployeePhone').value.trim();
            
            const employeeIndex = employees.findIndex(emp => emp.id === employeeId);
            if (employeeIndex === -1) return;
            
            const oldName = employees[employeeIndex].name;
            
            // Check if new name conflicts with another employee
            if (newName !== oldName && employees.some(emp => emp.name === newName)) {
                alert('ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸Ù Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø±.');
                return;
            }
            
            employees[employeeIndex] = {
                ...employees[employeeIndex],
                name: newName,
                password: newPassword,
                phone: newPhone
            };
            
            saveEmployees();
            renderEmployeesList();
            renderEmployeeStats();
            closeEditModal();
            
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­! âœ…');
        });

        // Delete employee
        window.deleteEmployee = function(employeeId, employeeName) {
            const empSales = salesRecords.filter(r => r.employee === employeeName);
            
            let confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù "${employeeName}"ØŸ`;
            if (empSales.length > 0) {
                confirmMessage += `\n\nâš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø¯ÙŠÙ‡ ${empSales.length} Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ù…Ø³Ø¬Ù„Ø©.\nØ³ÙŠØ¨Ù‚Ù‰ Ø³Ø¬Ù„ Ù…Ø¨ÙŠØ¹Ø§ØªÙ‡ØŒ Ù„ÙƒÙ† Ù„Ù† ÙŠØªÙ…ÙƒÙ† Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù†.`;
            }
            
            if (!confirm(confirmMessage)) return;
            
            employees = employees.filter(emp => emp.id !== employeeId);
            saveEmployees();
            renderEmployeesList();
            renderEmployeeStats();
            
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
        };

        // Lock functionality
        document.getElementById('lockBtn').addEventListener('click', () => {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                sessionStorage.removeItem('vault_pass');
                sessionStorage.removeItem('user_role');
                window.location.href = 'index.html';
            }
        });

        // Initialize
        async function init() {
            loadEmployees();
            await loadSalesData();
            renderEmployeesList();
            renderEmployeeStats();
        }

        init();
    </script>
</body>
</html>
