<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø²Ù†Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1>ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h1>
            <div class="header-actions">
                <button id="exportPdfBtn" class="btn btn-secondary" title="ØªØµØ¯ÙŠØ± PDF">ØªØµØ¯ÙŠØ± PDF ğŸ“„</button>
                <button id="lockBtn" class="btn btn-danger" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">Ù‚ÙÙ„ ğŸ”’</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">
                <span class="tab-icon">ğŸ“ˆ</span>
                <span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
            </button>
            <button class="tab-btn" data-tab="sales">
                <span class="tab-icon">ğŸ’°</span>
                <span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
            </button>
            <button class="tab-btn" data-tab="clients">
                <span class="tab-icon">ğŸ‘¥</span>
                <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
            </button>
            <button class="tab-btn" data-tab="credits">
                <span class="tab-icon">ğŸ’³</span>
                <span>Ø§Ù„Ø¯ÙŠÙˆÙ†</span>
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-info">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                        <div class="stat-value" id="totalClientsCount">0</div>
                    </div>
                </div>
                
                <div class="stat-card stat-success">
                    <div class="stat-icon">ğŸ’µ</div>
                    <div class="stat-info">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                        <div class="stat-value" id="totalRevenueAmount">0 Ø¯Ø¬</div>
                    </div>
                </div>
                
                <div class="stat-card stat-warning">
                    <div class="stat-icon">ğŸ’³</div>
                    <div class="stat-info">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
                        <div class="stat-value" id="totalDebtAmount">0 Ø¯Ø¬</div>
                    </div>
                </div>
                
                <div class="stat-card stat-info">
                    <div class="stat-icon">âš–ï¸</div>
                    <div class="stat-info">
                        <div class="stat-label">Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø¹</div>
                        <div class="stat-value" id="totalGramsSold">0 Øº</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©</h2>
                <div class="period-stats">
                    <div class="period-card">
                        <div class="period-header">
                            <h3>ğŸ“… Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©</h3>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</span>
                                <span class="period-value" id="clients1Day">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                                <span class="period-value" id="revenue1Day">0 Ø¯Ø¬</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ø°Ù‡Ø¨:</span>
                                <span class="period-value" id="grams1Day">0 Øº</span>
                            </div>
                        </div>
                    </div>

                    <div class="period-card">
                        <div class="period-header">
                            <h3>ğŸ“… Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</span>
                                <span class="period-value" id="clients7Days">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                                <span class="period-value" id="revenue7Days">0 Ø¯Ø¬</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ø°Ù‡Ø¨:</span>
                                <span class="period-value" id="grams7Days">0 Øº</span>
                            </div>
                        </div>
                    </div>

                    <div class="period-card">
                        <div class="period-header">
                            <h3>ğŸ“… Ø¢Ø®Ø± 14 ÙŠÙˆÙ…</h3>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</span>
                                <span class="period-value" id="clients14Days">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                                <span class="period-value" id="revenue14Days">0 Ø¯Ø¬</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ø°Ù‡Ø¨:</span>
                                <span class="period-value" id="grams14Days">0 Øº</span>
                            </div>
                        </div>
                    </div>

                    <div class="period-card">
                        <div class="period-header">
                            <h3>ğŸ“… Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</h3>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:</span>
                                <span class="period-value" id="clients30Days">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª:</span>
                                <span class="period-value" id="revenue30Days">0 Ø¯Ø¬</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">Ø§Ù„Ø°Ù‡Ø¨:</span>
                                <span class="period-value" id="grams30Days">0 Øº</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Tab -->
        <div class="tab-content" id="sales">

            <div class="card">
                <h2>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="salesForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
                        <input type="text" id="firstName" name="firstName" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
                    </div>
                    <div class="form-group">
                        <label for="lastName">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
                        <input type="text" id="lastName" name="lastName" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
                    </div>
                </div>
                
                    <div class="form-row">
                        <div class="form-group">
                            <label for="idNumber">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                            <input type="text" id="idNumber" name="idNumber" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©">
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ğŸ“±</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="0555123456">
                        </div>
                    </div>                <div class="form-row">
                    <div class="form-group">
                        <label for="grams">Ø§Ù„ÙˆØ²Ù† (ØºØ±Ø§Ù…)</label>
                        <input type="number" id="grams" name="grams" required step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="price">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯Ø¬)</label>
                        <input type="number" id="price" name="price" required step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="paid">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¯Ø¬)</label>
                    <input type="number" id="paid" name="paid" required step="0.01" min="0" placeholder="0.00">
                    <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                        ğŸ’¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø³Ø¹Ø±ØŒ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ù„Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© â•</button>
            </form>
            </div>

            <div class="card">
                <h2>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
                
                <!-- Search Box for Sales -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="salesSearchInput" 
                           placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="salesTableContainer">
                    <p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨ÙŠØ¹ Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                </div>
            </div>
        </div>

        <!-- Clients Tab -->
        <div class="tab-content" id="clients">
            <div class="card">
                <h2>ï¿½ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                
                <!-- Search Box for Clients -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="clientsSearchInput" 
                           placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="clientsListContainer">
                    <p class="empty-message">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</p>
                </div>
            </div>
        </div>

        <!-- Credits Tab -->
        <div class="tab-content" id="credits">
            <div class="card">
                <h2>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯</h2>
                <form id="creditForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditFirstName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
                            <input type="text" id="creditFirstName" name="creditFirstName" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„">
                        </div>
                        <div class="form-group">
                            <label for="creditLastName">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
                            <input type="text" id="creditLastName" name="creditLastName" required placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditIdNumber">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                            <input type="text" id="creditIdNumber" name="creditIdNumber" required placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ÙˆØ·Ù†ÙŠØ©">
                        </div>
                        <div class="form-group">
                            <label for="creditPhoneNumber">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ğŸ“±</label>
                            <input type="tel" id="creditPhoneNumber" name="creditPhoneNumber" required placeholder="0555123456">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditTotalAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯Ø¬)</label>
                            <input type="number" id="creditTotalAmount" name="creditTotalAmount" required step="0.01" min="0.01" placeholder="0.00">
                            <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                                Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹Ù‡
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="creditPaidAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¯Ø¬)</label>
                            <input type="number" id="creditPaidAmount" name="creditPaidAmount" required step="0.01" min="0" placeholder="0.00">
                            <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                                Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="creditNote">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="creditNote" name="creditNote" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¯ÙŠÙ† Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¶Ø§ÙÙŠØ©">
                    </div>
                    
                    <div class="credit-summary" id="creditSummary" style="display: none;">
                        <div class="summary-item">
                            <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                            <strong id="remainingAmount" style="color: #c92a2a; font-size: 1.25rem;">0.00 Ø¯Ø¬</strong>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙ† â•</button>
                </form>
            </div>

            <div class="card" id="creditClientsSection">
                <h2>ğŸ’³ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†</h2>
                
                <!-- Search Box for Credits -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="creditsSearchInput" 
                           placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="creditClientsContainer">
                    <p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø³Ø¬Ù„Ø©</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalClientInfo" style="margin-bottom: 1rem; font-weight: 600;"></p>
                <p id="modalDebtInfo" style="margin-bottom: 1.5rem; color: #dc2626; font-size: 1.1rem;"></p>
                
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="paymentAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¯Ø¬)</label>
                        <input type="number" id="paymentAmount" name="paymentAmount" required step="0.01" min="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="paymentNote">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="paymentNote" name="paymentNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ ÙˆØµÙ Ù„Ù„Ø¯ÙØ¹Ø©">
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© âœ…</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closePaymentModal()">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { encryptJSON, decryptJSON } from './crypto.js';
        import { saveVault, loadVault, syncOnStart } from './store.js';
        import { formatCurrency } from './app.js';

        // Check authentication
        const password = sessionStorage.getItem('vault_pass');
        if (!password) {
            window.location.href = 'index.html';
            throw new Error('Unauthorized');
        }

        let records = [];
        let currentPaymentRecordId = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Load existing data
        async function loadData() {
            try {
                console.log('ğŸ”„ Starting data load with cloud sync...');
                
                // STEP 1: Check cloud for updates (using password for user ID)
                const cloudData = await syncOnStart(password);
                
                let blob;
                if (cloudData) {
                    console.log('â˜ï¸ Using cloud data (newer or first time)');
                    blob = cloudData;
                    
                    // Save cloud data locally for offline use
                    try {
                        await saveVault(cloudData, password);
                        console.log('ğŸ’¾ Cloud data saved locally');
                    } catch (saveError) {
                        console.warn('âš ï¸ Could not save cloud data locally:', saveError);
                    }
                } else {
                    // STEP 2: If no cloud data, use local
                    console.log('ğŸ’¾ Using local data');
                    blob = await loadVault();
                }
                
                // STEP 3: Decrypt and load
                if (blob) {
                    const decrypted = await decryptJSON(blob, password);
                    if (Array.isArray(decrypted)) {
                        records = decrypted;
                        console.log('âœ… Data loaded successfully:', records.length, 'records');
                    }
                }
            } catch (error) {
                console.error('Failed to load data:', error.message);
                alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‚Ø¯ ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
                sessionStorage.removeItem('vault_pass');
                window.location.href = 'index.html';
            }
            renderDashboard();
            renderTable();
            renderClientsList();
            renderCreditClients();
        }

        // Calculate statistics
        function calculateStats() {
            const now = new Date();
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const fourteenDaysAgo = new Date(now - 14 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            // Get unique clients
            const uniqueClients = new Set();
            records.forEach(r => uniqueClients.add(r.idNumber));

            // Calculate totals
            let totalRevenue = 0;
            let totalDebt = 0;
            let totalGrams = 0;

            const stats1Day = { clients: new Set(), revenue: 0, grams: 0 };
            const stats7Days = { clients: new Set(), revenue: 0, grams: 0 };
            const stats14Days = { clients: new Set(), revenue: 0, grams: 0 };
            const stats30Days = { clients: new Set(), revenue: 0, grams: 0 };

            records.forEach(record => {
                const recordDate = new Date(record.date);
                const totalPaid = getTotalPaid(record);
                const debt = record.price - totalPaid;

                totalRevenue += totalPaid;
                totalDebt += debt;
                totalGrams += record.grams;

                // Period statistics
                if (recordDate >= oneDayAgo) {
                    stats1Day.clients.add(record.idNumber);
                    stats1Day.revenue += record.price;
                    stats1Day.grams += record.grams;
                }
                if (recordDate >= sevenDaysAgo) {
                    stats7Days.clients.add(record.idNumber);
                    stats7Days.revenue += record.price;
                    stats7Days.grams += record.grams;
                }
                if (recordDate >= fourteenDaysAgo) {
                    stats14Days.clients.add(record.idNumber);
                    stats14Days.revenue += record.price;
                    stats14Days.grams += record.grams;
                }
                if (recordDate >= thirtyDaysAgo) {
                    stats30Days.clients.add(record.idNumber);
                    stats30Days.revenue += record.price;
                    stats30Days.grams += record.grams;
                }
            });

            return {
                totalClients: uniqueClients.size,
                totalRevenue,
                totalDebt,
                totalGrams,
                period1Day: { clients: stats1Day.clients.size, revenue: stats1Day.revenue, grams: stats1Day.grams },
                period7Days: { clients: stats7Days.clients.size, revenue: stats7Days.revenue, grams: stats7Days.grams },
                period14Days: { clients: stats14Days.clients.size, revenue: stats14Days.revenue, grams: stats14Days.grams },
                period30Days: { clients: stats30Days.clients.size, revenue: stats30Days.revenue, grams: stats30Days.grams }
            };
        }

        // Render dashboard
        function renderDashboard() {
            const stats = calculateStats();

            document.getElementById('totalClientsCount').textContent = stats.totalClients;
            document.getElementById('totalRevenueAmount').textContent = formatCurrency(stats.totalRevenue);
            document.getElementById('totalDebtAmount').textContent = formatCurrency(stats.totalDebt);
            document.getElementById('totalGramsSold').textContent = stats.totalGrams.toFixed(2) + ' Øº';

            document.getElementById('clients1Day').textContent = stats.period1Day.clients;
            document.getElementById('revenue1Day').textContent = formatCurrency(stats.period1Day.revenue);
            document.getElementById('grams1Day').textContent = stats.period1Day.grams.toFixed(2) + ' Øº';

            document.getElementById('clients7Days').textContent = stats.period7Days.clients;
            document.getElementById('revenue7Days').textContent = formatCurrency(stats.period7Days.revenue);
            document.getElementById('grams7Days').textContent = stats.period7Days.grams.toFixed(2) + ' Øº';

            document.getElementById('clients14Days').textContent = stats.period14Days.clients;
            document.getElementById('revenue14Days').textContent = formatCurrency(stats.period14Days.revenue);
            document.getElementById('grams14Days').textContent = stats.period14Days.grams.toFixed(2) + ' Øº';

            document.getElementById('clients30Days').textContent = stats.period30Days.clients;
            document.getElementById('revenue30Days').textContent = formatCurrency(stats.period30Days.revenue);
            document.getElementById('grams30Days').textContent = stats.period30Days.grams.toFixed(2) + ' Øº';
        }

        // Save data
        async function saveData() {
            try {
                const encrypted = await encryptJSON(records, password);
                await saveVault(encrypted, password); // Pass password for cloud sync
            } catch (error) {
                console.error('Failed to save data:', error.message);
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                throw error;
            }
        }

        // Calculate total paid including payment history
        function getTotalPaid(record) {
            let total = record.paid || 0;
            if (record.payments && Array.isArray(record.payments)) {
                total += record.payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            }
            return total;
        }

        // Render table
        function renderTable() {
            const container = document.getElementById('salesTableContainer');
            
            // Filter records based on search
            let filteredRecords = records;
            if (currentSalesFilter) {
                filteredRecords = records.filter(record => {
                    const fullName = `${record.firstName} ${record.lastName}`.toLowerCase();
                    const phone = (record.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentSalesFilter) || phone.includes(currentSalesFilter);
                });
            }
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'sales-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„ÙˆØ²Ù† (Øº)</th>
                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                        <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                        <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredRecords.map((record, index) => {
                        const date = new Date(record.date);
                        const dateStr = date.toLocaleDateString('ar-DZ', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const customerName = `${record.firstName} ${record.lastName}`;
                        const totalPaid = getTotalPaid(record);
                        const due = record.price - totalPaid;
                        const hasPaidFully = due <= 0;
                        const isCreditOnly = record.isCreditOnly === true;
                        
                        return `
                            <tr class="${isCreditOnly ? 'credit-only-row' : ''}">
                                <td>${dateStr}</td>
                                <td>
                                    ${customerName}
                                    ${record.phoneNumber ? '<br><small style="color: #0c8599;">ğŸ“± ' + record.phoneNumber + '</small>' : ''}
                                    ${record.note ? '<br><small style="color: #6c757d;">(' + record.note + ')</small>' : ''}
                                </td>
                                <td>${record.idNumber}</td>
                                <td>
                                    ${isCreditOnly 
                                        ? '<span class="badge badge-info">Ø¯ÙŠÙ† ÙÙ‚Ø·</span>' 
                                        : '<span class="badge badge-primary">Ø¨ÙŠØ¹</span>'
                                    }
                                </td>
                                <td>${record.grams > 0 ? record.grams.toFixed(2) : '-'}</td>
                                <td>${formatCurrency(record.price)}</td>
                                <td>${formatCurrency(totalPaid)}</td>
                                <td class="${due > 0 ? 'due-amount' : 'paid-full'}">${formatCurrency(due)}</td>
                                <td>
                                    ${hasPaidFully 
                                        ? '<span class="badge badge-success">Ù…Ø¯ÙÙˆØ¹ âœ“</span>' 
                                        : `<span class="badge badge-warning">Ø¯ÙŠÙ†</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Render clients list
        function renderClientsList() {
            const container = document.getElementById('clientsListContainer');
            
            // Group records by client
            const clientsMap = new Map();
            
            records.forEach(record => {
                const clientKey = record.idNumber;
                if (!clientsMap.has(clientKey)) {
                    clientsMap.set(clientKey, {
                        firstName: record.firstName,
                        lastName: record.lastName,
                        idNumber: record.idNumber,
                        phoneNumber: record.phoneNumber,
                        transactions: [],
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDebt: 0,
                        totalGrams: 0
                    });
                }
                
                const client = clientsMap.get(clientKey);
                const totalPaid = getTotalPaid(record);
                const debt = record.price - totalPaid;
                
                client.transactions.push(record);
                client.totalSpent += record.price;
                client.totalPaid += totalPaid;
                client.totalDebt += debt;
                client.totalGrams += record.grams;
            });
            
            if (clientsMap.size === 0) {
                container.innerHTML = '<p class="empty-message">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯</p>';
                return;
            }
            
            let clientsArray = Array.from(clientsMap.values()).sort((a, b) => b.totalSpent - a.totalSpent);
            
            // Filter clients based on search
            if (currentClientsFilter) {
                clientsArray = clientsArray.filter(client => {
                    const fullName = `${client.firstName} ${client.lastName}`.toLowerCase();
                    const phone = (client.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentClientsFilter) || phone.includes(currentClientsFilter);
                });
            }
            
            if (clientsArray.length === 0) {
                container.innerHTML = '<p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="clients-grid">
                    ${clientsArray.map(client => {
                        const customerName = `${client.firstName} ${client.lastName}`;
                        const hasDebt = client.totalDebt > 0;
                        
                        return `
                            <div class="client-card ${hasDebt ? 'client-has-debt' : ''}">
                                <div class="client-header">
                                    <div class="client-avatar">${client.firstName.charAt(0)}${client.lastName.charAt(0)}</div>
                                    <div>
                                        <h3 class="client-name">${customerName}</h3>
                                        <p class="client-id">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: ${client.idNumber}</p>
                                        ${client.transactions[0].phoneNumber ? `<p class="client-phone">ğŸ“± ${client.transactions[0].phoneNumber}</p>` : ''}
                                    </div>
                                </div>
                                <div class="client-stats">
                                    <div class="client-stat">
                                        <span class="client-stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</span>
                                        <span class="client-stat-value">${client.transactions.length}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                                        <span class="client-stat-value">${formatCurrency(client.totalSpent)}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</span>
                                        <span class="client-stat-value">${formatCurrency(client.totalPaid)}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">Ø§Ù„Ø¯ÙŠÙˆÙ†</span>
                                        <span class="client-stat-value ${hasDebt ? 'text-danger' : 'text-success'}">
                                            ${formatCurrency(client.totalDebt)}
                                        </span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø´ØªØ±Ù‰</span>
                                        <span class="client-stat-value">${client.totalGrams.toFixed(2)} Øº</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Render credit clients section
        function renderCreditClients() {
            const container = document.getElementById('creditClientsContainer');
            
            // Filter records with outstanding debt
            let debtors = records
                .map((record, index) => ({ ...record, originalIndex: index }))
                .filter(record => {
                    const totalPaid = getTotalPaid(record);
                    return record.price - totalPaid > 0;
                })
                .sort((a, b) => {
                    const dueA = a.price - getTotalPaid(a);
                    const dueB = b.price - getTotalPaid(b);
                    return dueB - dueA; // Highest debt first
                });
            
            // Filter debtors based on search
            if (currentCreditsFilter) {
                debtors = debtors.filter(record => {
                    const fullName = `${record.firstName} ${record.lastName}`.toLowerCase();
                    const phone = (record.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentCreditsFilter) || phone.includes(currentCreditsFilter);
                });
            }
            
            if (debtors.length === 0) {
                container.innerHTML = '<p class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
                return;
            }
            
            container.innerHTML = debtors.map(record => {
                const customerName = `${record.firstName} ${record.lastName}`;
                const totalPaid = getTotalPaid(record);
                const due = record.price - totalPaid;
                const lastPaymentDate = record.payments && record.payments.length > 0 
                    ? new Date(record.payments[record.payments.length - 1].date).toLocaleDateString('ar-DZ')
                    : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¹Ø¯';
                
                return `
                    <div class="credit-card">
                        <div class="credit-header">
                            <div>
                                <h3>${customerName}</h3>
                                <p class="credit-id">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: ${record.idNumber}</p>
                                ${record.phoneNumber ? `<p class="credit-phone">ğŸ“± ${record.phoneNumber}</p>` : ''}
                            </div>
                            <div class="credit-amount">${formatCurrency(due)}</div>
                        </div>
                        <div class="credit-details">
                            <div class="credit-detail-item">
                                <span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙƒÙ„ÙŠ:</span>
                                <strong>${formatCurrency(record.price)}</strong>
                            </div>
                            <div class="credit-detail-item">
                                <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                                <strong>${formatCurrency(totalPaid)}</strong>
                            </div>
                            <div class="credit-detail-item">
                                <span>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙØ¹Ø©:</span>
                                <strong>${lastPaymentDate}</strong>
                            </div>
                        </div>
                        <div class="credit-actions">
                            ${record.phoneNumber ? `<a href="tel:${record.phoneNumber}" class="btn btn-success btn-sm">Ø§ØªØµØ§Ù„ ğŸ“</a>` : ''}
                            <button class="btn btn-primary btn-sm" onclick="openPaymentModal('${record.id || record.originalIndex}')">
                                Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© ğŸ’°
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showPaymentHistory('${record.id || record.originalIndex}')">
                                Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª ğŸ“‹
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        window.openPaymentModal = function(recordId) {
            const record = records.find((r, i) => (r.id || i) == recordId);
            if (!record) return;
            
            currentPaymentRecordId = recordId;
            const customerName = `${record.firstName} ${record.lastName}`;
            const totalPaid = getTotalPaid(record);
            const due = record.price - totalPaid;
            
            document.getElementById('modalClientInfo').textContent = `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customerName} (${record.idNumber})`;
            document.getElementById('modalDebtInfo').textContent = `Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(due)}`;
            document.getElementById('paymentAmount').max = due;
            document.getElementById('paymentModal').style.display = 'flex';
        };

        window.closePaymentModal = function() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
            currentPaymentRecordId = null;
        };

        window.showPaymentHistory = function(recordId) {
            const record = records.find((r, i) => (r.id || i) == recordId);
            if (!record) return;
            
            const customerName = `${record.firstName} ${record.lastName}`;
            const payments = record.payments || [];
            
            if (payments.length === 0) {
                alert(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„: ${customerName}`);
                return;
            }
            
            let historyHTML = `<div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; margin: 0 auto;">`;
            historyHTML += `<h3 style="margin-bottom: 1rem;">ğŸ“‹ Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª: ${customerName}</h3>`;
            historyHTML += `<table class="payment-history-table" style="width: 100%; border-collapse: collapse;">`;
            historyHTML += `<thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead><tbody>`;
            
            payments.forEach(payment => {
                const date = new Date(payment.date).toLocaleString('ar-DZ', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                historyHTML += `
                    <tr>
                        <td>${date}</td>
                        <td style="color: #16a34a; font-weight: 600;">${formatCurrency(payment.amount)}</td>
                        <td>${payment.note || '-'}</td>
                    </tr>
                `;
            });
            
            historyHTML += `</tbody></table></div>`;
            
            const historyWindow = window.open('', 'Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª', 'width=700,height=500');
            historyWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª - ${customerName}</title>
                    <link rel="stylesheet" href="styles.css">
                    <style>
                        body { padding: 2rem; background: #f1f5f9; }
                        .payment-history-table th { background: #f1f5f9; padding: 0.75rem; text-align: right; border-bottom: 2px solid #e2e8f0; }
                        .payment-history-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
                    </style>
                </head>
                <body>${historyHTML}</body>
                </html>
            `);
        };

        // Credit form - calculate remaining amount in real-time
        document.getElementById('creditTotalAmount').addEventListener('input', updateCreditSummary);
        document.getElementById('creditPaidAmount').addEventListener('input', updateCreditSummary);

        function updateCreditSummary() {
            const total = parseFloat(document.getElementById('creditTotalAmount').value) || 0;
            const paid = parseFloat(document.getElementById('creditPaidAmount').value) || 0;
            const remaining = total - paid;
            
            const summaryDiv = document.getElementById('creditSummary');
            const remainingSpan = document.getElementById('remainingAmount');
            
            if (total > 0) {
                summaryDiv.style.display = 'block';
                remainingSpan.textContent = formatCurrency(remaining);
                remainingSpan.style.color = remaining > 0 ? '#c92a2a' : '#2f9e44';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        // Credit form submission
        document.getElementById('creditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const totalAmount = parseFloat(formData.get('creditTotalAmount'));
            const paidAmount = parseFloat(formData.get('creditPaidAmount'));
            
            if (paidAmount > totalAmount) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
                return;
            }
            
            const newRecord = {
                id: Date.now().toString(),
                firstName: formData.get('creditFirstName').trim(),
                lastName: formData.get('creditLastName').trim(),
                idNumber: formData.get('creditIdNumber').trim(),
                phoneNumber: formData.get('creditPhoneNumber').trim(),
                grams: 0, // No gold transaction, just credit
                price: totalAmount,
                paid: paidAmount,
                date: new Date().toISOString(),
                payments: [],
                note: formData.get('creditNote').trim(),
                isCreditOnly: true // Mark as credit-only entry
            };
            
            // Prepend to records
            records.unshift(newRecord);
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                e.target.reset();
                document.getElementById('creditSummary').style.display = 'none';
                document.getElementById('creditFirstName').focus();
                
                const remaining = totalAmount - paidAmount;
                alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${newRecord.firstName} ${newRecord.lastName}\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(totalAmount)}\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${formatCurrency(paidAmount)}\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remaining)}`);
            } catch (error) {
                // Remove the record if save failed
                records.shift();
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        });

        // Payment form submission
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const recordIndex = records.findIndex((r, i) => (r.id || i) == currentPaymentRecordId);
            if (recordIndex === -1) return;
            
            const formData = new FormData(e.target);
            const amount = parseFloat(formData.get('paymentAmount'));
            const note = formData.get('paymentNote').trim();
            
            const record = records[recordIndex];
            const totalPaid = getTotalPaid(record);
            const due = record.price - totalPaid;
            
            if (amount > due) {
                alert(`Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ù„ (${formatCurrency(amount)}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (${formatCurrency(due)})`);
                return;
            }
            
            // Initialize payments array if not exists
            if (!record.payments) {
                record.payments = [];
            }
            
            // Add payment
            record.payments.push({
                amount: amount,
                note: note,
                date: new Date().toISOString()
            });
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                closePaymentModal();
                alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­: ${formatCurrency(amount)}`);
            } catch (error) {
                // Remove the payment if save failed
                record.payments.pop();
                alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©');
            }
        });

        // Form submission
        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const newRecord = {
                id: Date.now().toString(),
                firstName: formData.get('firstName').trim(),
                lastName: formData.get('lastName').trim(),
                idNumber: formData.get('idNumber').trim(),
                phoneNumber: formData.get('phoneNumber').trim(),
                grams: parseFloat(formData.get('grams')),
                price: parseFloat(formData.get('price')),
                paid: parseFloat(formData.get('paid')),
                date: new Date().toISOString(),
                payments: []
            };

            // Prepend to records
            records.unshift(newRecord);
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                e.target.reset();
                document.getElementById('firstName').focus();
                
                // Show alert if there's remaining debt
                const due = newRecord.price - newRecord.paid;
                if (due > 0) {
                    setTimeout(() => {
                        alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(due)}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${newRecord.firstName} ${newRecord.lastName}`);
                    }, 100);
                }
            } catch (error) {
                // Remove the record if save failed
                records.shift();
            }
        });

        // PDF Export functionality
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            const stats = calculateStats();
            const today = new Date().toLocaleDateString('ar-DZ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</title>
                    <style>
                        body {
                            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                            padding: 20mm;
                            color: #212529;
                            direction: rtl;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #1a5490;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            color: #1a5490;
                            margin: 0 0 10px 0;
                        }
                        .header p {
                            color: #6c757d;
                            margin: 5px 0;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        .stat-box {
                            border: 2px solid #dee2e6;
                            border-radius: 8px;
                            padding: 15px;
                            text-align: center;
                        }
                        .stat-label {
                            font-size: 12px;
                            color: #6c757d;
                            margin-bottom: 5px;
                        }
                        .stat-value {
                            font-size: 20px;
                            font-weight: bold;
                            color: #1a5490;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        th, td {
                            border: 1px solid #dee2e6;
                            padding: 10px;
                            text-align: right;
                            font-size: 11px;
                        }
                        th {
                            background: #f5f7fa;
                            font-weight: 600;
                            color: #212529;
                        }
                        .debt-row {
                            background: #fff9f9;
                        }
                        .paid-row {
                            background: #f0f9ff;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #dee2e6;
                            color: #6c757d;
                            font-size: 11px;
                        }
                        .debt-text {
                            color: #c92a2a;
                            font-weight: bold;
                        }
                        .paid-text {
                            color: #2f9e44;
                            font-weight: bold;
                        }
                        @media print {
                            body { padding: 10mm; }
                            .stat-box { break-inside: avoid; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h1>
                        <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today}</p>
                        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ${records.length}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                            <div class="stat-value">${stats.totalClients}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                            <div class="stat-value">${formatCurrency(stats.totalRevenue)}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
                            <div class="stat-value" style="color: #c92a2a;">${formatCurrency(stats.totalDebt)}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø¹</div>
                            <div class="stat-value">${stats.totalGrams.toFixed(2)} Øº</div>
                        </div>
                    </div>
                    
                    <h2 style="color: #1a5490; margin-bottom: 15px;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                <th>Ø§Ù„ÙˆØ²Ù† (Øº)</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(record => {
                                const date = new Date(record.date);
                                const dateStr = date.toLocaleDateString('ar-DZ', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                });
                                const customerName = record.firstName + ' ' + record.lastName;
                                const totalPaid = getTotalPaid(record);
                                const due = record.price - totalPaid;
                                const isCreditOnly = record.isCreditOnly === true;
                                const rowClass = due > 0 ? 'debt-row' : 'paid-row';
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td>${dateStr}</td>
                                        <td>${customerName}</td>
                                        <td>${record.phoneNumber || '-'}</td>
                                        <td>${record.idNumber}</td>
                                        <td>${isCreditOnly ? 'Ø¯ÙŠÙ† ÙÙ‚Ø·' : 'Ø¨ÙŠØ¹'}</td>
                                        <td>${record.grams > 0 ? record.grams.toFixed(2) : '-'}</td>
                                        <td>${formatCurrency(record.price)}</td>
                                        <td>${formatCurrency(totalPaid)}</td>
                                        <td class="${due > 0 ? 'debt-text' : 'paid-text'}">${formatCurrency(due)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>Ø®Ø²Ù†Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø´ÙØ±Ø©</strong></p>
                        <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ${new Date().toLocaleString('ar-DZ')}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 500);
        });



        // Lock functionality
        document.getElementById('lockBtn').addEventListener('click', () => {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                sessionStorage.removeItem('vault_pass');
                window.location.href = 'index.html';
            }
        });

        // Search functionality for Sales
        let currentSalesFilter = '';
        document.getElementById('salesSearchInput').addEventListener('input', (e) => {
            currentSalesFilter = e.target.value.toLowerCase().trim();
            renderTable();
        });

        // Search functionality for Clients
        let currentClientsFilter = '';
        document.getElementById('clientsSearchInput').addEventListener('input', (e) => {
            currentClientsFilter = e.target.value.toLowerCase().trim();
            renderClientsList();
        });

        // Search functionality for Credits
        let currentCreditsFilter = '';
        document.getElementById('creditsSearchInput').addEventListener('input', (e) => {
            currentCreditsFilter = e.target.value.toLowerCase().trim();
            renderCreditClients();
        });

        // Initialize
        loadData();
    </script>
</body>
</html>
