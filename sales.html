<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฎุฒูุฉ ูุจูุนุงุช ุงูุฐูุจ - ุฅุฏุงุฑุฉ ุงููุจูุนุงุช</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <h1>๐ ุฅุฏุงุฑุฉ ูุจูุนุงุช ุงูุฐูุจ</h1>
            <div class="header-actions">
                <button onclick="if(confirm('๐๏ธ ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉุ\n\nูุฐุง ุณูุญุฐู:\nโ ุฌููุน ุงููุจูุนุงุช\nโ ุฌููุน ุงูุนููุงุก\nโ ุฌููุน ุงูุฏููู\nโ ุฌููุน ุงููุฏุฎุฑุงุช\nโ ุฌููุน ุนูููุงุช ุงูุดุฑุงุก\n\nโ๏ธ ูุง ูููู ุงูุชุฑุงุฌุน!\n\nุงุณุชูุฑุงุฑุ')) window.location.href='clear-all-data.html'" class="btn" title="ุญุฐู ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); margin-left: 0.5rem;">
                    ๐๏ธ ุญุฐู ุงูุจูุงูุงุช
                </button>
                <button onclick="window.location.href='manage-employees.html'" class="btn btn-info" title="ุฅุฏุงุฑุฉ ุงูููุธููู" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); margin-left: 0.5rem;">
                    ๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู
                </button>
                <button id="exportPdfBtn" class="btn btn-secondary" title="ุชุตุฏูุฑ PDF">ุชุตุฏูุฑ PDF ๐</button>
                <button id="lockBtn" class="btn btn-danger" title="ุชุณุฌูู ุงูุฎุฑูุฌ">ููู ๐</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="dashboard">
                <span class="tab-icon">๐</span>
                <span>ููุญุฉ ุงูุชุญูู</span>
            </button>
            <button class="tab-btn" data-tab="sales">
                <span class="tab-icon">๐ฐ</span>
                <span>ุงููุจูุนุงุช</span>
            </button>
            <button class="tab-btn" data-tab="clients">
                <span class="tab-icon">๐ฅ</span>
                <span>ุงูุนููุงุก</span>
            </button>
            <button class="tab-btn" data-tab="credits">
                <span class="tab-icon">๐ณ</span>
                <span>ุงูุฏููู</span>
            </button>
            <button class="tab-btn" data-tab="savings">
                <span class="tab-icon">๐ฐ</span>
                <span>ุงููุฏุฎุฑุงุช</span>
            </button>
            <button class="tab-btn" data-tab="purchases">
                <span class="tab-icon">๐</span>
                <span>ุดุฑุงุก ุงูุฐูุจ</span>
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">๐ฅ</div>
                    <div class="stat-info">
                        <div class="stat-label">ุฅุฌูุงูู ุงูุนููุงุก</div>
                        <div class="stat-value" id="totalClientsCount">0</div>
                    </div>
                </div>
                
                <div class="stat-card stat-success">
                    <div class="stat-icon">๐ต</div>
                    <div class="stat-info">
                        <div class="stat-label">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
                        <div class="stat-value" id="totalRevenueAmount">0 ุฏุฌ</div>
                    </div>
                </div>
                
                <div class="stat-card stat-warning">
                    <div class="stat-icon">๐ณ</div>
                    <div class="stat-info">
                        <div class="stat-label">ุฅุฌูุงูู ุงูุฏููู</div>
                        <div class="stat-value" id="totalDebtAmount">0 ุฏุฌ</div>
                    </div>
                </div>
                
                <div class="stat-card stat-info">
                    <div class="stat-icon">โ๏ธ</div>
                    <div class="stat-info">
                        <div class="stat-label">ุงูุฐูุจ ุงููุจุงุน</div>
                        <div class="stat-value" id="totalGramsSold">0 ุบ</div>
                    </div>
                </div>
                
                <div class="stat-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-right: 4px solid #16a34a;">
                    <div class="stat-icon" style="background: #16a34a; color: white;">๐ฐ</div>
                    <div class="stat-info">
                        <div class="stat-label">ุฅุฌูุงูู ุงููุฏุฎุฑุงุช</div>
                        <div class="stat-value" id="totalSavingsAmount" style="color: #16a34a;">0 ุฏุฌ</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>๐ ุฅุญุตุงุฆูุงุช ุงูุนููุงุก ุญุณุจ ุงููุชุฑุฉ</h2>
                <div class="period-stats">
                    <div class="period-card" onclick="showPeriodDetails(1)" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="period-header">
                            <h3>๐ ุขุฎุฑ 24 ุณุงุนุฉ</h3>
                            <small style="color: #64748b; font-size: 0.85rem;">๐ ุงููุฑ ูุฑุคูุฉ ุงูุชูุงุตูู</small>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">ุนุฏุฏ ุงูุนููุงุก:</span>
                                <span class="period-value" id="clients1Day">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงููุจูุนุงุช:</span>
                                <span class="period-value" id="revenue1Day">0 ุฏุฌ</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงูุฐูุจ ุงููุจุงุน:</span>
                                <span class="period-value" id="grams1Day">0 ุบ</span>
                            </div>
                            <div class="period-item" style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;">
                                <span class="period-label" style="color: #059669;">๐ ุงูุฐูุจ ุงููุดุชุฑู:</span>
                                <span class="period-value" style="color: #059669;" id="purchased1Day">0 ุบ</span>
                            </div>
                        </div>
                    </div>

                    <div class="period-card" onclick="showPeriodDetails(7)" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="period-header">
                            <h3>๐ ุขุฎุฑ 7 ุฃูุงู</h3>
                            <small style="color: #64748b; font-size: 0.85rem;">๐ ุงููุฑ ูุฑุคูุฉ ุงูุชูุงุตูู</small>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">ุนุฏุฏ ุงูุนููุงุก:</span>
                                <span class="period-value" id="clients7Days">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงููุจูุนุงุช:</span>
                                <span class="period-value" id="revenue7Days">0 ุฏุฌ</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงูุฐูุจ ุงููุจุงุน:</span>
                                <span class="period-value" id="grams7Days">0 ุบ</span>
                            </div>
                            <div class="period-item" style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;">
                                <span class="period-label" style="color: #059669;">๐ ุงูุฐูุจ ุงููุดุชุฑู:</span>
                                <span class="period-value" style="color: #059669;" id="purchased7Days">0 ุบ</span>
                            </div>
                        </div>
                    </div>

                    <div class="period-card" onclick="showPeriodDetails(14)" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="period-header">
                            <h3>๐ ุขุฎุฑ 14 ููู</h3>
                            <small style="color: #64748b; font-size: 0.85rem;">๐ ุงููุฑ ูุฑุคูุฉ ุงูุชูุงุตูู</small>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">ุนุฏุฏ ุงูุนููุงุก:</span>
                                <span class="period-value" id="clients14Days">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงููุจูุนุงุช:</span>
                                <span class="period-value" id="revenue14Days">0 ุฏุฌ</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงูุฐูุจ ุงููุจุงุน:</span>
                                <span class="period-value" id="grams14Days">0 ุบ</span>
                            </div>
                            <div class="period-item" style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;">
                                <span class="period-label" style="color: #059669;">๐ ุงูุฐูุจ ุงููุดุชุฑู:</span>
                                <span class="period-value" style="color: #059669;" id="purchased14Days">0 ุบ</span>
                            </div>
                        </div>
                    </div>

                    <div class="period-card" onclick="showPeriodDetails(30)" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        <div class="period-header">
                            <h3>๐ ุขุฎุฑ 30 ููู</h3>
                            <small style="color: #64748b; font-size: 0.85rem;">๐ ุงููุฑ ูุฑุคูุฉ ุงูุชูุงุตูู</small>
                        </div>
                        <div class="period-content">
                            <div class="period-item">
                                <span class="period-label">ุนุฏุฏ ุงูุนููุงุก:</span>
                                <span class="period-value" id="clients30Days">0</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงููุจูุนุงุช:</span>
                                <span class="period-value" id="revenue30Days">0 ุฏุฌ</span>
                            </div>
                            <div class="period-item">
                                <span class="period-label">ุงูุฐูุจ ุงููุจุงุน:</span>
                                <span class="period-value" id="grams30Days">0 ุบ</span>
                            </div>
                            <div class="period-item" style="border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;">
                                <span class="period-label" style="color: #059669;">๐ ุงูุฐูุจ ุงููุดุชุฑู:</span>
                                <span class="period-value" style="color: #059669;" id="purchased30Days">0 ุบ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Tab -->
        <div class="tab-content" id="sales">

            <div class="card">
                <h2>ุฅุถุงูุฉ ุนูููุฉ ุจูุน ุฌุฏูุฏุฉ</h2>
            <form id="salesForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">ุงูุงุณู ุงูุฃูู</label>
                        <input type="text" id="firstName" name="firstName" required placeholder="ุงูุงุณู ุงูุฃูู">
                    </div>
                    <div class="form-group">
                        <label for="lastName">ุงุณู ุงูุนุงุฆูุฉ</label>
                        <input type="text" id="lastName" name="lastName" required placeholder="ุงุณู ุงูุนุงุฆูุฉ">
                    </div>
                </div>
                
                    <div class="form-row">
                        <div class="form-group">
                            <label for="idNumber">ุฑูู ุงููููุฉ (ุงุฎุชูุงุฑู)</label>
                            <input type="text" id="idNumber" name="idNumber" placeholder="ุฑูู ุงููููุฉ ุงููุทููุฉ">
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">ุฑูู ุงููุงุชู ๐ฑ (ุงุฎุชูุงุฑู)</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="0555123456">
                        </div>
                    </div>                <div class="form-row">
                    <div class="form-group">
                        <label for="grams">ุงููุฒู (ุบุฑุงู)</label>
                        <input type="number" id="grams" name="grams" required step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="price">ุงูุณุนุฑ ุงูุฅุฌูุงูู (ุฏุฌ)</label>
                        <input type="number" id="price" name="price" required step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="paid">ุงููุจูุบ ุงููุฏููุน (ุฏุฌ)</label>
                    <input type="number" id="paid" name="paid" required step="0.01" min="0" placeholder="0.00">
                    <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                        ๐ก ุฅุฐุง ูุงู ุงููุจูุบ ุฃูู ูู ุงูุณุนุฑุ ุณูุชู ุฅุถุงูุฉ ุฏูู ููุนููู ุชููุงุฆูุงู
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary">ุฅุถุงูุฉ ุงูุนูููุฉ โ</button>
            </form>
            </div>

            <div class="card">
                <h2>ุณุฌู ุงููุจูุนุงุช</h2>
                
                <!-- Search Box for Sales -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="salesSearchInput" 
                           placeholder="๐ ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="salesTableContainer">
                    <p class="empty-message">ูุง ุชูุฌุฏ ุนูููุงุช ุจูุน ูุณุฌูุฉ ุจุนุฏ</p>
                </div>
            </div>
        </div>

        <!-- Clients Tab -->
        <div class="tab-content" id="clients">
            <div class="card">
                <h2>๏ฟฝ ูุงุฆูุฉ ุงูุนููุงุก</h2>
                
                <!-- Search Box for Clients -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="clientsSearchInput" 
                           placeholder="๐ ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="clientsListContainer">
                    <p class="empty-message">ูุง ููุฌุฏ ุนููุงุก ูุณุฌููู ุจุนุฏ</p>
                </div>
            </div>
        </div>

        <!-- Credits Tab -->
        <div class="tab-content" id="credits">
            <div class="card">
                <h2>โ ุฅุถุงูุฉ ุนููู ูุฏูู ุฌุฏูุฏ</h2>
                <form id="creditForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditFirstName">ุงูุงุณู ุงูุฃูู</label>
                            <input type="text" id="creditFirstName" name="creditFirstName" required placeholder="ุงูุงุณู ุงูุฃูู">
                        </div>
                        <div class="form-group">
                            <label for="creditLastName">ุงุณู ุงูุนุงุฆูุฉ</label>
                            <input type="text" id="creditLastName" name="creditLastName" required placeholder="ุงุณู ุงูุนุงุฆูุฉ">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditIdNumber">ุฑูู ุงููููุฉ (ุงุฎุชูุงุฑู)</label>
                            <input type="text" id="creditIdNumber" name="creditIdNumber" placeholder="ุฑูู ุงููููุฉ ุงููุทููุฉ">
                        </div>
                        <div class="form-group">
                            <label for="creditPhoneNumber">ุฑูู ุงููุงุชู ๐ฑ (ุงุฎุชูุงุฑู)</label>
                            <input type="tel" id="creditPhoneNumber" name="creditPhoneNumber" placeholder="0555123456">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditTotalAmount">ุงููุจูุบ ุงูุฅุฌูุงูู (ุฏุฌ)</label>
                            <input type="number" id="creditTotalAmount" name="creditTotalAmount" required step="0.01" min="0.01" placeholder="0.00">
                            <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                                ุงููุจูุบ ุงูููู ุงูุฐู ูุฌุจ ุนูู ุงูุนููู ุฏูุนู
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="creditPaidAmount">ุงููุจูุบ ุงููุฏููุน (ุฏุฌ)</label>
                            <input type="number" id="creditPaidAmount" name="creditPaidAmount" required step="0.01" min="0" placeholder="0.00">
                            <small style="display: block; margin-top: 0.5rem; color: #6c757d;">
                                ุงููุจูุบ ุงูุฐู ุฏูุนู ุงูุนููู ุญุชู ุงูุขู
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="creditNote">ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="creditNote" name="creditNote" placeholder="ุณุจุจ ุงูุฏูู ุฃู ููุงุญุธุฉ ุฅุถุงููุฉ">
                    </div>
                    
                    <div class="credit-summary" id="creditSummary" style="display: none;">
                        <div class="summary-item">
                            <span>ุงููุจูุบ ุงููุชุจูู:</span>
                            <strong id="remainingAmount" style="color: #c92a2a; font-size: 1.25rem;">0.00 ุฏุฌ</strong>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">ุฅุถุงูุฉ ุงูุนููู ุงููุฏูู โ</button>
                </form>
            </div>

            <div class="card" id="creditClientsSection">
                <h2>๐ณ ูุงุฆูุฉ ุงูุนููุงุก ุงููุฏูููู</h2>
                
                <!-- Search Box for Credits -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="creditsSearchInput" 
                           placeholder="๐ ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="creditClientsContainer">
                    <p class="empty-message">ูุง ุชูุฌุฏ ุฏููู ูุณุฌูุฉ</p>
                </div>
            </div>
        </div>

        <!-- Savings Tab -->
        <div class="tab-content" id="savings">
            <div class="card">
                <h2>๐ฐ ุฅุถุงูุฉ ูุฏุฎุฑุงุช ูุนููู</h2>
                <p class="subtitle" style="color: #64748b; margin-bottom: 1.5rem;">
                    ุงูุนููู ูุฏูุน ูุจูุบุงู ููุงุฏุฎุงุฑ ุนูุฏู ูุดุฑุงุก ููุชุฌ ูุงุญูุงู (ูุซู ุฎุงุชูุ ุณูุงุฑุ ุฅูุฎ)
                </p>
                
                <form id="savingsForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="savingsFirstName">ุงูุงุณู ุงูุฃูู</label>
                            <input type="text" id="savingsFirstName" name="savingsFirstName" required placeholder="ุงูุงุณู ุงูุฃูู">
                        </div>
                        <div class="form-group">
                            <label for="savingsLastName">ุงุณู ุงูุนุงุฆูุฉ</label>
                            <input type="text" id="savingsLastName" name="savingsLastName" required placeholder="ุงุณู ุงูุนุงุฆูุฉ">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="savingsIdNumber">ุฑูู ุงููููุฉ (ุงุฎุชูุงุฑู)</label>
                            <input type="text" id="savingsIdNumber" name="savingsIdNumber" placeholder="ุฑูู ุงููููุฉ ุงููุทููุฉ">
                        </div>
                        <div class="form-group">
                            <label for="savingsPhoneNumber">ุฑูู ุงููุงุชู ๐ฑ (ุงุฎุชูุงุฑู)</label>
                            <input type="tel" id="savingsPhoneNumber" name="savingsPhoneNumber" placeholder="0555123456">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="savingsAmount">ุงููุจูุบ ุงููุฏุฎุฑ (ุฏุฌ)</label>
                        <input type="number" id="savingsAmount" name="savingsAmount" required step="0.01" min="0.01" placeholder="0.00">
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                            ๐ก ุงููุจูุบ ุงูุฐู ูุฏูุนู ุงูุนููู ููุงุฏุฎุงุฑ
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="savingsGoal">ุงููุฏู ูู ุงูุงุฏุฎุงุฑ (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="savingsGoal" name="savingsGoal" placeholder="ูุซุงู: ุฎุงุชู ุฐูุจุ ุณูุงุฑุ ุนูุฏุ ุฅูุฎ">
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                            ๐ ูุง ุงูุฐู ูุฑูุฏ ุงูุนููู ุดุฑุงุกูุ
                        </small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">ุฅุถุงูุฉ ุงููุฏุฎุฑุงุช ๐ฐ</button>
                </form>
            </div>

            <div class="card">
                <h2>๐ ูุงุฆูุฉ ุงูุนููุงุก ุงููุฏุฎุฑูู</h2>
                
                <!-- Search Box for Savings -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="savingsSearchInput" 
                           placeholder="๐ ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="savingsClientsContainer">
                    <p class="empty-message">ูุง ุชูุฌุฏ ูุฏุฎุฑุงุช ูุณุฌูุฉ</p>
                </div>
            </div>
        </div>

        <!-- Gold Purchases Tab (Buy from Customers) -->
        <div class="tab-content" id="purchases">
            <div class="card">
                <h2>๐ ุดุฑุงุก ุฐูุจ ูู ุนููู</h2>
                <p class="subtitle" style="color: #64748b; margin-bottom: 1.5rem;">
                    ุนูุฏูุง ูุฃุชู ุนููู ูุจูุน ุฐูุจ ูู - ุฃูุช ุชุดุชุฑู ููู
                </p>
                
                <form id="purchaseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchaseFirstName">ุงูุงุณู ุงูุฃูู</label>
                            <input type="text" id="purchaseFirstName" name="purchaseFirstName" required placeholder="ุงูุงุณู ุงูุฃูู">
                        </div>
                        <div class="form-group">
                            <label for="purchaseLastName">ุงุณู ุงูุนุงุฆูุฉ</label>
                            <input type="text" id="purchaseLastName" name="purchaseLastName" required placeholder="ุงุณู ุงูุนุงุฆูุฉ">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchaseIdNumber">ุฑูู ุงููููุฉ (ุงุฎุชูุงุฑู)</label>
                            <input type="text" id="purchaseIdNumber" name="purchaseIdNumber" placeholder="ุฑูู ุงููููุฉ ุงููุทููุฉ">
                        </div>
                        <div class="form-group">
                            <label for="purchasePhoneNumber">ุฑูู ุงููุงุชู ๐ฑ (ุงุฎุชูุงุฑู)</label>
                            <input type="tel" id="purchasePhoneNumber" name="purchasePhoneNumber" placeholder="0555123456">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchaseGrams">ุงููุฒู (ุบุฑุงู)</label>
                            <input type="number" id="purchaseGrams" name="purchaseGrams" required step="0.01" min="0.01" placeholder="0.00">
                            <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                                โ๏ธ ูุฒู ุงูุฐูุจ ุงูุฐู ูุจูุนู ุงูุนููู ูู
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="purchasePrice">ุงูุณุนุฑ ุงููุชูู ุนููู (ุฏุฌ)</label>
                            <input type="number" id="purchasePrice" name="purchasePrice" required step="0.01" min="0" placeholder="0.00">
                            <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                                ๐ฐ ุงูุณุนุฑ ุงูุฐู ุณุชุฏูุนู ููุนููู
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchasePaid">ุงููุจูุบ ุงููุฏููุน ููุนููู (ุฏุฌ)</label>
                        <input type="number" id="purchasePaid" name="purchasePaid" required step="0.01" min="0" placeholder="0.00">
                        <small style="display: block; margin-top: 0.5rem; color: #64748b;">
                            ๐ต ุงููุจูุบ ุงูุฐู ุฏูุนุชู ููุนููู ุงูุขู
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="purchaseNote">ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="purchaseNote" name="purchaseNote" placeholder="ููุน ุงูุฐูุจุ ุงูุนูุงุฑุ ูุตู ุงููุทุนุฉุ ุฅูุฎ">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);">
                        ุดุฑุงุก ุงูุฐูุจ ๐
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>๐ ุณุฌู ูุดุชุฑูุงุช ุงูุฐูุจ</h2>
                
                <!-- Search Box -->
                <div class="search-box" style="margin-bottom: 1.5rem;">
                    <input type="text" 
                           id="purchasesSearchInput" 
                           placeholder="๐ ุงูุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู..." 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                </div>
                
                <div id="purchasesListContainer">
                    <p class="empty-message">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Period Details Modal -->
    <div id="periodDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="periodDetailsTitle">๐ ุชูุงุตูู ุงููุชุฑุฉ</h2>
                <button class="modal-close" onclick="closePeriodDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Summary Cards -->
                <div class="stats-grid" style="margin-bottom: 2rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card stat-success">
                        <div class="stat-icon">๐ต</div>
                        <div class="stat-info">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
                            <div class="stat-value" id="periodTotalRevenue">0 ุฏุฌ</div>
                        </div>
                    </div>
                    <div class="stat-card stat-warning">
                        <div class="stat-icon">๐ณ</div>
                        <div class="stat-info">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุฏููู</div>
                            <div class="stat-value" id="periodTotalDebt">0 ุฏุฌ</div>
                        </div>
                    </div>
                    <div class="stat-card stat-info">
                        <div class="stat-icon">โ๏ธ</div>
                        <div class="stat-info">
                            <div class="stat-label">ุงูุฐูุจ ุงููุจุงุน</div>
                            <div class="stat-value" id="periodTotalGrams">0 ุบ</div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white;">
                        <div class="stat-icon">๐</div>
                        <div class="stat-info">
                            <div class="stat-label">ุงูุฐูุจ ุงููุดุชุฑู</div>
                            <div class="stat-value" id="periodTotalPurchased">0 ุบ</div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Table -->
                <div id="periodDetailsTable"></div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>๐ฐ ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ</h2>
                <button class="modal-close" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalClientInfo" style="margin-bottom: 1rem; font-weight: 600;"></p>
                <p id="modalDebtInfo" style="margin-bottom: 1.5rem; color: #dc2626; font-size: 1.1rem;"></p>
                
                <form id="paymentForm">
                    <div class="form-group">
                        <label for="paymentAmount">ุงููุจูุบ ุงููุฏููุน (ุฏุฌ)</label>
                        <input type="number" id="paymentAmount" name="paymentAmount" required step="0.01" min="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="paymentNote">ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="paymentNote" name="paymentNote" placeholder="ููุงุญุธุฉ ุฃู ูุตู ููุฏูุนุฉ">
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">ุชุณุฌูู ุงูุฏูุนุฉ โ</button>
                        <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="closePaymentModal()">ุฅูุบุงุก</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { encryptJSON, decryptJSON } from './crypto.js';
        import { saveVault, loadVault, syncOnStart } from './store.js';
        import { formatCurrency } from './app.js';

        // Check authentication
        const password = sessionStorage.getItem('vault_pass');
        if (!password) {
            window.location.href = 'index.html';
            throw new Error('Unauthorized');
        }

        let records = [];
        let purchases = []; // Gold purchases from customers
        let currentPaymentRecordId = null;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Load existing data
        async function loadData() {
            try {
                console.log('๐ Starting data load...');
                
                // STEP 1: Try loading from local storage first
                console.log('๐พ Loading from local storage');
                let blob = await loadVault();
                
                // STEP 2: If no local data, check cloud (only if local is empty)
                if (!blob) {
                    console.log('โ๏ธ No local data, checking cloud...');
                    const cloudData = await syncOnStart(password);
                    
                    if (cloudData) {
                        console.log('โ๏ธ Using cloud data');
                        blob = cloudData;
                        
                        // Save cloud data locally for offline use
                        try {
                            await saveVault(cloudData, password);
                            console.log('๐พ Cloud data saved locally');
                        } catch (saveError) {
                            console.warn('โ๏ธ Could not save cloud data locally:', saveError);
                        }
                    }
                }
                
                // STEP 3: Decrypt and load
                if (blob) {
                    const decrypted = await decryptJSON(blob, password);
                    if (Array.isArray(decrypted)) {
                        records = decrypted;
                        console.log('โ Data loaded successfully:', records.length, 'records');
                    }
                }
                
                // Load purchases (stored separately)
                try {
                    const purchasesStr = localStorage.getItem('gold_purchases');
                    if (purchasesStr) {
                        purchases = JSON.parse(purchasesStr);
                        console.log('โ Purchases loaded:', purchases.length, 'purchases');
                    }
                } catch (e) {
                    console.warn('Could not load purchases:', e);
                    purchases = [];
                }
            } catch (error) {
                console.error('Failed to load data:', error.message);
                alert('ูุดู ุชุญููู ุงูุจูุงูุงุช. ูุฏ ุชููู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.');
                sessionStorage.removeItem('vault_pass');
                window.location.href = 'index.html';
            }
            renderDashboard();
            renderTable();
            renderClientsList();
            renderCreditClients();
            renderSavingsClients();
            renderPurchasesList();
        }

        // Calculate statistics
        function calculateStats() {
            const now = new Date();
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            const fourteenDaysAgo = new Date(now - 14 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            // Get unique clients
            const uniqueClients = new Set();
            records.forEach(r => uniqueClients.add(r.idNumber));

            // Calculate totals
            let totalRevenue = 0;
            let totalDebt = 0;
            let totalGrams = 0;
            let totalSavings = 0;

            const stats1Day = { clients: new Set(), revenue: 0, grams: 0, purchasedGrams: 0, purchasedAmount: 0 };
            const stats7Days = { clients: new Set(), revenue: 0, grams: 0, purchasedGrams: 0, purchasedAmount: 0 };
            const stats14Days = { clients: new Set(), revenue: 0, grams: 0, purchasedGrams: 0, purchasedAmount: 0 };
            const stats30Days = { clients: new Set(), revenue: 0, grams: 0, purchasedGrams: 0, purchasedAmount: 0 };

            records.forEach(record => {
                const recordDate = new Date(record.date);
                const totalPaid = getTotalPaid(record);
                const debt = record.price - totalPaid;

                // Calculate savings (negative paid = customer has credit with us)
                if (totalPaid < 0) {
                    totalSavings += -totalPaid;
                } else {
                    totalRevenue += totalPaid;
                    totalDebt += debt;
                }
                
                totalGrams += record.grams;

                // Period statistics
                if (recordDate >= oneDayAgo) {
                    stats1Day.clients.add(record.idNumber);
                    stats1Day.revenue += record.price;
                    stats1Day.grams += record.grams;
                }
                if (recordDate >= sevenDaysAgo) {
                    stats7Days.clients.add(record.idNumber);
                    stats7Days.revenue += record.price;
                    stats7Days.grams += record.grams;
                }
                if (recordDate >= fourteenDaysAgo) {
                    stats14Days.clients.add(record.idNumber);
                    stats14Days.revenue += record.price;
                    stats14Days.grams += record.grams;
                }
                if (recordDate >= thirtyDaysAgo) {
                    stats30Days.clients.add(record.idNumber);
                    stats30Days.revenue += record.price;
                    stats30Days.grams += record.grams;
                }
            });

            // Calculate purchase statistics (gold bought FROM customers)
            purchases.forEach(purchase => {
                const purchaseDate = new Date(purchase.date);
                
                if (purchaseDate >= oneDayAgo) {
                    stats1Day.purchasedGrams += purchase.grams;
                    stats1Day.purchasedAmount += purchase.price;
                }
                if (purchaseDate >= sevenDaysAgo) {
                    stats7Days.purchasedGrams += purchase.grams;
                    stats7Days.purchasedAmount += purchase.price;
                }
                if (purchaseDate >= fourteenDaysAgo) {
                    stats14Days.purchasedGrams += purchase.grams;
                    stats14Days.purchasedAmount += purchase.price;
                }
                if (purchaseDate >= thirtyDaysAgo) {
                    stats30Days.purchasedGrams += purchase.grams;
                    stats30Days.purchasedAmount += purchase.price;
                }
            });

            return {
                totalClients: uniqueClients.size,
                totalRevenue,
                totalDebt,
                totalGrams,
                totalSavings,
                period1Day: { 
                    clients: stats1Day.clients.size, 
                    revenue: stats1Day.revenue, 
                    grams: stats1Day.grams,
                    purchasedGrams: stats1Day.purchasedGrams,
                    purchasedAmount: stats1Day.purchasedAmount
                },
                period7Days: { 
                    clients: stats7Days.clients.size, 
                    revenue: stats7Days.revenue, 
                    grams: stats7Days.grams,
                    purchasedGrams: stats7Days.purchasedGrams,
                    purchasedAmount: stats7Days.purchasedAmount
                },
                period14Days: { 
                    clients: stats14Days.clients.size, 
                    revenue: stats14Days.revenue, 
                    grams: stats14Days.grams,
                    purchasedGrams: stats14Days.purchasedGrams,
                    purchasedAmount: stats14Days.purchasedAmount
                },
                period30Days: { 
                    clients: stats30Days.clients.size, 
                    revenue: stats30Days.revenue, 
                    grams: stats30Days.grams,
                    purchasedGrams: stats30Days.purchasedGrams,
                    purchasedAmount: stats30Days.purchasedAmount
                }
            };
        }

        // Render dashboard
        function renderDashboard() {
            const stats = calculateStats();

            document.getElementById('totalClientsCount').textContent = stats.totalClients;
            document.getElementById('totalRevenueAmount').textContent = formatCurrency(stats.totalRevenue);
            document.getElementById('totalDebtAmount').textContent = formatCurrency(stats.totalDebt);
            document.getElementById('totalGramsSold').textContent = stats.totalGrams.toFixed(2) + ' ุบ';
            document.getElementById('totalSavingsAmount').textContent = formatCurrency(stats.totalSavings);

            document.getElementById('clients1Day').textContent = stats.period1Day.clients;
            document.getElementById('revenue1Day').textContent = formatCurrency(stats.period1Day.revenue);
            document.getElementById('grams1Day').textContent = stats.period1Day.grams.toFixed(2) + ' ุบ';
            document.getElementById('purchased1Day').textContent = stats.period1Day.purchasedGrams.toFixed(2) + ' ุบ';

            document.getElementById('clients7Days').textContent = stats.period7Days.clients;
            document.getElementById('revenue7Days').textContent = formatCurrency(stats.period7Days.revenue);
            document.getElementById('grams7Days').textContent = stats.period7Days.grams.toFixed(2) + ' ุบ';
            document.getElementById('purchased7Days').textContent = stats.period7Days.purchasedGrams.toFixed(2) + ' ุบ';

            document.getElementById('clients14Days').textContent = stats.period14Days.clients;
            document.getElementById('revenue14Days').textContent = formatCurrency(stats.period14Days.revenue);
            document.getElementById('grams14Days').textContent = stats.period14Days.grams.toFixed(2) + ' ุบ';
            document.getElementById('purchased14Days').textContent = stats.period14Days.purchasedGrams.toFixed(2) + ' ุบ';

            document.getElementById('clients30Days').textContent = stats.period30Days.clients;
            document.getElementById('revenue30Days').textContent = formatCurrency(stats.period30Days.revenue);
            document.getElementById('grams30Days').textContent = stats.period30Days.grams.toFixed(2) + ' ุบ';
            document.getElementById('purchased30Days').textContent = stats.period30Days.purchasedGrams.toFixed(2) + ' ุบ';
        }

        // Save data
        async function saveData() {
            try {
                const encrypted = await encryptJSON(records, password);
                await saveVault(encrypted, password); // Pass password for cloud sync
            } catch (error) {
                console.error('Failed to save data:', error.message);
                alert('ูุดู ุญูุธ ุงูุจูุงูุงุช. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
                throw error;
            }
        }

        // Calculate total paid including payment history
        function getTotalPaid(record) {
            let total = record.paid || 0;
            if (record.payments && Array.isArray(record.payments)) {
                total += record.payments.reduce((sum, p) => sum + (p.amount || 0), 0);
            }
            return total;
        }

        // Render table
        function renderTable() {
            const container = document.getElementById('salesTableContainer');
            
            // Filter records based on search
            let filteredRecords = records;
            if (currentSalesFilter) {
                filteredRecords = records.filter(record => {
                    const fullName = `${record.firstName} ${record.lastName}`.toLowerCase();
                    const phone = (record.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentSalesFilter) || phone.includes(currentSalesFilter);
                });
            }
            
            if (filteredRecords.length === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'sales-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุนููู</th>
                        <th>ุฑูู ุงููููุฉ</th>
                        <th>ุงูููุน</th>
                        <th>ุงููุฒู (ุบ)</th>
                        <th>ุงูุณุนุฑ</th>
                        <th>ุงููุฏููุน</th>
                        <th>ุงููุชุจูู</th>
                        <th>ุงูุญุงูุฉ</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredRecords.map((record, index) => {
                        const date = new Date(record.date);
                        const dateStr = date.toLocaleDateString('ar-DZ', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const customerName = `${record.firstName} ${record.lastName}`;
                        const totalPaid = getTotalPaid(record);
                        const due = record.price - totalPaid;
                        const hasPaidFully = due <= 0;
                        const isCreditOnly = record.isCreditOnly === true;
                        
                        return `
                            <tr class="${isCreditOnly ? 'credit-only-row' : ''}">
                                <td>${dateStr}</td>
                                <td>
                                    ${customerName}
                                    ${record.employee ? '<br><span class="badge" style="background: #7c3aed; font-size: 0.75rem;">๐ค ' + record.employee + '</span>' : ''}
                                    ${record.phoneNumber ? '<br><small style="color: #0c8599;">๐ฑ ' + record.phoneNumber + '</small>' : ''}
                                    ${record.note ? '<br><small style="color: #6c757d;">(' + record.note + ')</small>' : ''}
                                </td>
                                <td>${record.idNumber}</td>
                                <td>
                                    ${isCreditOnly 
                                        ? '<span class="badge badge-info">ุฏูู ููุท</span>' 
                                        : '<span class="badge badge-primary">ุจูุน</span>'
                                    }
                                </td>
                                <td>${record.grams > 0 ? record.grams.toFixed(2) : '-'}</td>
                                <td>${formatCurrency(record.price)}</td>
                                <td>${formatCurrency(totalPaid)}</td>
                                <td class="${due > 0 ? 'due-amount' : 'paid-full'}">${formatCurrency(due)}</td>
                                <td>
                                    ${hasPaidFully 
                                        ? '<span class="badge badge-success">ูุฏููุน โ</span>' 
                                        : `<span class="badge badge-warning">ุฏูู</span>`
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Render clients list
        function renderClientsList() {
            const container = document.getElementById('clientsListContainer');
            
            // Group records by client
            const clientsMap = new Map();
            
            records.forEach(record => {
                const clientKey = record.idNumber;
                if (!clientsMap.has(clientKey)) {
                    clientsMap.set(clientKey, {
                        firstName: record.firstName,
                        lastName: record.lastName,
                        idNumber: record.idNumber,
                        phoneNumber: record.phoneNumber,
                        transactions: [],
                        totalSpent: 0,
                        totalPaid: 0,
                        totalDebt: 0,
                        totalGrams: 0
                    });
                }
                
                const client = clientsMap.get(clientKey);
                const totalPaid = getTotalPaid(record);
                const debt = record.price - totalPaid;
                
                client.transactions.push(record);
                client.totalSpent += record.price;
                client.totalPaid += totalPaid;
                client.totalDebt += debt;
                client.totalGrams += record.grams;
            });
            
            if (clientsMap.size === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ููุฌุฏ ุนููุงุก ูุณุฌููู ุจุนุฏ</p>';
                return;
            }
            
            let clientsArray = Array.from(clientsMap.values()).sort((a, b) => b.totalSpent - a.totalSpent);
            
            // Filter clients based on search
            if (currentClientsFilter) {
                clientsArray = clientsArray.filter(client => {
                    const fullName = `${client.firstName} ${client.lastName}`.toLowerCase();
                    const phone = (client.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentClientsFilter) || phone.includes(currentClientsFilter);
                });
            }
            
            if (clientsArray.length === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="clients-grid">
                    ${clientsArray.map(client => {
                        const customerName = `${client.firstName} ${client.lastName}`;
                        const hasDebt = client.totalDebt > 0;
                        
                        return `
                            <div class="client-card ${hasDebt ? 'client-has-debt' : ''}">
                                <div class="client-header">
                                    <div class="client-avatar">${client.firstName.charAt(0)}${client.lastName.charAt(0)}</div>
                                    <div>
                                        <h3 class="client-name">${customerName}</h3>
                                        <p class="client-id">ุฑูู ุงููููุฉ: ${client.idNumber}</p>
                                        ${client.transactions[0].phoneNumber ? `<p class="client-phone">๐ฑ ${client.transactions[0].phoneNumber}</p>` : ''}
                                    </div>
                                </div>
                                <div class="client-stats">
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุนุฏุฏ ุงูุนูููุงุช</span>
                                        <span class="client-stat-value">${client.transactions.length}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุฅุฌูุงูู ุงููุดุชุฑูุงุช</span>
                                        <span class="client-stat-value">${formatCurrency(client.totalSpent)}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุงููุฏููุน</span>
                                        <span class="client-stat-value">${formatCurrency(client.totalPaid)}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุงูุฏููู</span>
                                        <span class="client-stat-value ${hasDebt ? 'text-danger' : 'text-success'}">
                                            ${formatCurrency(client.totalDebt)}
                                        </span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุงูุฐูุจ ุงููุดุชุฑู</span>
                                        <span class="client-stat-value">${client.totalGrams.toFixed(2)} ุบ</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Render credit clients section
        function renderCreditClients() {
            const container = document.getElementById('creditClientsContainer');
            
            // Filter records with outstanding debt
            let debtors = records
                .map((record, index) => ({ ...record, originalIndex: index }))
                .filter(record => {
                    const totalPaid = getTotalPaid(record);
                    return record.price - totalPaid > 0;
                })
                .sort((a, b) => {
                    const dueA = a.price - getTotalPaid(a);
                    const dueB = b.price - getTotalPaid(b);
                    return dueB - dueA; // Highest debt first
                });
            
            // Filter debtors based on search
            if (currentCreditsFilter) {
                debtors = debtors.filter(record => {
                    const fullName = `${record.firstName} ${record.lastName}`.toLowerCase();
                    const phone = (record.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentCreditsFilter) || phone.includes(currentCreditsFilter);
                });
            }
            
            if (debtors.length === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>';
                return;
            }
            
            container.innerHTML = debtors.map(record => {
                const customerName = `${record.firstName} ${record.lastName}`;
                const totalPaid = getTotalPaid(record);
                const due = record.price - totalPaid;
                const lastPaymentDate = record.payments && record.payments.length > 0 
                    ? new Date(record.payments[record.payments.length - 1].date).toLocaleDateString('ar-DZ')
                    : 'ูู ูุชู ุงูุฏูุน ุจุนุฏ';
                
                return `
                    <div class="credit-card">
                        <div class="credit-header">
                            <div>
                                <h3>${customerName}</h3>
                                <p class="credit-id">ุฑูู ุงููููุฉ: ${record.idNumber}</p>
                                ${record.phoneNumber ? `<p class="credit-phone">๐ฑ ${record.phoneNumber}</p>` : ''}
                            </div>
                            <div class="credit-amount">${formatCurrency(due)}</div>
                        </div>
                        <div class="credit-details">
                            <div class="credit-detail-item">
                                <span>ุงูุณุนุฑ ุงูููู:</span>
                                <strong>${formatCurrency(record.price)}</strong>
                            </div>
                            <div class="credit-detail-item">
                                <span>ุงููุฏููุน:</span>
                                <strong>${formatCurrency(totalPaid)}</strong>
                            </div>
                            <div class="credit-detail-item">
                                <span>ุชุงุฑูุฎ ุขุฎุฑ ุฏูุนุฉ:</span>
                                <strong>${lastPaymentDate}</strong>
                            </div>
                        </div>
                        <div class="credit-actions">
                            ${record.phoneNumber ? `<a href="tel:${record.phoneNumber}" class="btn btn-success btn-sm">ุงุชุตุงู ๐</a>` : ''}
                            <button class="btn btn-primary btn-sm" onclick="openPaymentModal('${record.id || record.originalIndex}')">
                                ุฅุถุงูุฉ ุฏูุนุฉ ๐ฐ
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showPaymentHistory('${record.id || record.originalIndex}')">
                                ุณุฌู ุงูุฏูุนุงุช ๐
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        window.openPaymentModal = function(recordId) {
            const record = records.find((r, i) => (r.id || i) == recordId);
            if (!record) return;
            
            currentPaymentRecordId = recordId;
            const customerName = `${record.firstName} ${record.lastName}`;
            const totalPaid = getTotalPaid(record);
            const due = record.price - totalPaid;
            
            document.getElementById('modalClientInfo').textContent = `ุงูุนููู: ${customerName} (${record.idNumber})`;
            document.getElementById('modalDebtInfo').textContent = `ุงููุจูุบ ุงููุชุจูู: ${formatCurrency(due)}`;
            document.getElementById('paymentAmount').max = due;
            document.getElementById('paymentModal').style.display = 'flex';
        };

        window.closePaymentModal = function() {
            document.getElementById('paymentModal').style.display = 'none';
            document.getElementById('paymentForm').reset();
            currentPaymentRecordId = null;
        };

        window.showPaymentHistory = function(recordId) {
            const record = records.find((r, i) => (r.id || i) == recordId);
            if (!record) return;
            
            const customerName = `${record.firstName} ${record.lastName}`;
            const payments = record.payments || [];
            
            if (payments.length === 0) {
                alert(`ูุง ุชูุฌุฏ ุฏูุนุงุช ูุณุฌูุฉ ููุนููู: ${customerName}`);
                return;
            }
            
            let historyHTML = `<div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; margin: 0 auto;">`;
            historyHTML += `<h3 style="margin-bottom: 1rem;">๐ ุณุฌู ุฏูุนุงุช: ${customerName}</h3>`;
            historyHTML += `<table class="payment-history-table" style="width: 100%; border-collapse: collapse;">`;
            historyHTML += `<thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงููุจูุบ</th><th>ููุงุญุธุฉ</th></tr></thead><tbody>`;
            
            payments.forEach(payment => {
                const date = new Date(payment.date).toLocaleString('ar-DZ', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                historyHTML += `
                    <tr>
                        <td>${date}</td>
                        <td style="color: #16a34a; font-weight: 600;">${formatCurrency(payment.amount)}</td>
                        <td>${payment.note || '-'}</td>
                    </tr>
                `;
            });
            
            historyHTML += `</tbody></table></div>`;
            
            const historyWindow = window.open('', 'ุณุฌู ุงูุฏูุนุงุช', 'width=700,height=500');
            historyWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ุณุฌู ุงูุฏูุนุงุช - ${customerName}</title>
                    <link rel="stylesheet" href="styles.css">
                    <style>
                        body { padding: 2rem; background: #f1f5f9; }
                        .payment-history-table th { background: #f1f5f9; padding: 0.75rem; text-align: right; border-bottom: 2px solid #e2e8f0; }
                        .payment-history-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
                    </style>
                </head>
                <body>${historyHTML}</body>
                </html>
            `);
        };

        // Credit form - calculate remaining amount in real-time
        document.getElementById('creditTotalAmount').addEventListener('input', updateCreditSummary);
        document.getElementById('creditPaidAmount').addEventListener('input', updateCreditSummary);

        function updateCreditSummary() {
            const total = parseFloat(document.getElementById('creditTotalAmount').value) || 0;
            const paid = parseFloat(document.getElementById('creditPaidAmount').value) || 0;
            const remaining = total - paid;
            
            const summaryDiv = document.getElementById('creditSummary');
            const remainingSpan = document.getElementById('remainingAmount');
            
            if (total > 0) {
                summaryDiv.style.display = 'block';
                remainingSpan.textContent = formatCurrency(remaining);
                remainingSpan.style.color = remaining > 0 ? '#c92a2a' : '#2f9e44';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        // Credit form submission
        document.getElementById('creditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const totalAmount = parseFloat(formData.get('creditTotalAmount'));
            const paidAmount = parseFloat(formData.get('creditPaidAmount'));
            
            if (paidAmount > totalAmount) {
                alert('ุงููุจูุบ ุงููุฏููุน ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงููุจูุบ ุงูุฅุฌูุงูู');
                return;
            }
            
            // Generate unique ID if not provided (for credits too)
            const creditIdNumber = formData.get('creditIdNumber').trim() || `AUTO_${Date.now()}`;
            const creditPhoneNumber = formData.get('creditPhoneNumber').trim() || '';
            
            const newRecord = {
                id: Date.now().toString(),
                firstName: formData.get('creditFirstName').trim(),
                lastName: formData.get('creditLastName').trim(),
                idNumber: creditIdNumber,
                phoneNumber: creditPhoneNumber,
                grams: 0, // No gold transaction, just credit
                price: totalAmount,
                paid: paidAmount,
                date: new Date().toISOString(),
                payments: [],
                note: formData.get('creditNote').trim(),
                isCreditOnly: true // Mark as credit-only entry
            };
            
            // Prepend to records
            records.unshift(newRecord);
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                e.target.reset();
                document.getElementById('creditSummary').style.display = 'none';
                document.getElementById('creditFirstName').focus();
                
                const remaining = totalAmount - paidAmount;
                alert(`ุชู ุฅุถุงูุฉ ุงูุนููู ุงููุฏูู ุจูุฌุงุญ!\n\nุงูุนููู: ${newRecord.firstName} ${newRecord.lastName}\nุงููุจูุบ ุงูุฅุฌูุงูู: ${formatCurrency(totalAmount)}\nุงููุจูุบ ุงููุฏููุน: ${formatCurrency(paidAmount)}\nุงููุจูุบ ุงููุชุจูู: ${formatCurrency(remaining)}`);
            } catch (error) {
                // Remove the record if save failed
                records.shift();
                alert('ูุดู ุญูุธ ุงูุจูุงูุงุช');
            }
        });

        // Payment form submission
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const recordIndex = records.findIndex((r, i) => (r.id || i) == currentPaymentRecordId);
            if (recordIndex === -1) return;
            
            const formData = new FormData(e.target);
            const amount = parseFloat(formData.get('paymentAmount'));
            const note = formData.get('paymentNote').trim();
            
            const record = records[recordIndex];
            const totalPaid = getTotalPaid(record);
            const due = record.price - totalPaid;
            
            if (amount > due) {
                alert(`ุงููุจูุบ ุงููุฏุฎู (${formatCurrency(amount)}) ุฃูุจุฑ ูู ุงููุจูุบ ุงููุชุจูู (${formatCurrency(due)})`);
                return;
            }
            
            // Initialize payments array if not exists
            if (!record.payments) {
                record.payments = [];
            }
            
            // Add payment
            record.payments.push({
                amount: amount,
                note: note,
                date: new Date().toISOString()
            });
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                closePaymentModal();
                alert(`ุชู ุชุณุฌูู ุงูุฏูุนุฉ ุจูุฌุงุญ: ${formatCurrency(amount)}`);
            } catch (error) {
                // Remove the payment if save failed
                record.payments.pop();
                alert('ูุดู ุญูุธ ุงูุฏูุนุฉ');
            }
        });

        // Form submission
        document.getElementById('salesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Generate unique ID if not provided
            const idNumber = formData.get('idNumber').trim() || `AUTO_${Date.now()}`;
            const phoneNumber = formData.get('phoneNumber').trim() || '';
            
            const newRecord = {
                id: Date.now().toString(),
                firstName: formData.get('firstName').trim(),
                lastName: formData.get('lastName').trim(),
                idNumber: idNumber,
                phoneNumber: phoneNumber,
                grams: parseFloat(formData.get('grams')),
                price: parseFloat(formData.get('price')),
                paid: parseFloat(formData.get('paid')),
                date: new Date().toISOString(),
                payments: []
            };

            // Prepend to records
            records.unshift(newRecord);
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                e.target.reset();
                document.getElementById('firstName').focus();
                
                // Show alert if there's remaining debt
                const due = newRecord.price - newRecord.paid;
                if (due > 0) {
                    setTimeout(() => {
                        alert(`ุชู ุฅุถุงูุฉ ุงูุนูููุฉ. ุงููุจูุบ ุงููุชุจูู: ${formatCurrency(due)}\nุงูุนููู: ${newRecord.firstName} ${newRecord.lastName}`);
                    }, 100);
                }
            } catch (error) {
                // Remove the record if save failed
                records.shift();
            }
        });

        // PDF Export functionality
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            const stats = calculateStats();
            const today = new Date().toLocaleDateString('ar-DZ', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>ุชูุฑูุฑ ูุจูุนุงุช ุงูุฐูุจ</title>
                    <style>
                        body {
                            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                            padding: 20mm;
                            color: #212529;
                            direction: rtl;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #1a5490;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            color: #1a5490;
                            margin: 0 0 10px 0;
                        }
                        .header p {
                            color: #6c757d;
                            margin: 5px 0;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                            margin-bottom: 30px;
                        }
                        .stat-box {
                            border: 2px solid #dee2e6;
                            border-radius: 8px;
                            padding: 15px;
                            text-align: center;
                        }
                        .stat-label {
                            font-size: 12px;
                            color: #6c757d;
                            margin-bottom: 5px;
                        }
                        .stat-value {
                            font-size: 20px;
                            font-weight: bold;
                            color: #1a5490;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        th, td {
                            border: 1px solid #dee2e6;
                            padding: 10px;
                            text-align: right;
                            font-size: 11px;
                        }
                        th {
                            background: #f5f7fa;
                            font-weight: 600;
                            color: #212529;
                        }
                        .debt-row {
                            background: #fff9f9;
                        }
                        .paid-row {
                            background: #f0f9ff;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #dee2e6;
                            color: #6c757d;
                            font-size: 11px;
                        }
                        .debt-text {
                            color: #c92a2a;
                            font-weight: bold;
                        }
                        .paid-text {
                            color: #2f9e44;
                            font-weight: bold;
                        }
                        @media print {
                            body { padding: 10mm; }
                            .stat-box { break-inside: avoid; }
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>๐ ุชูุฑูุฑ ูุจูุนุงุช ุงูุฐูุจ</h1>
                        <p>ุงูุชุงุฑูุฎ: ${today}</p>
                        <p>ุนุฏุฏ ุงูุนูููุงุช: ${records.length}</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุนููุงุก</div>
                            <div class="stat-value">${stats.totalClients}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช</div>
                            <div class="stat-value">${formatCurrency(stats.totalRevenue)}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ุฅุฌูุงูู ุงูุฏููู</div>
                            <div class="stat-value" style="color: #c92a2a;">${formatCurrency(stats.totalDebt)}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">ุงูุฐูุจ ุงููุจุงุน</div>
                            <div class="stat-value">${stats.totalGrams.toFixed(2)} ุบ</div>
                        </div>
                    </div>
                    
                    <h2 style="color: #1a5490; margin-bottom: 15px;">ุฌุฏูู ุงููุจูุนุงุช</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th>ุงูุนููู</th>
                                <th>ุงููุงุชู</th>
                                <th>ุฑูู ุงููููุฉ</th>
                                <th>ุงูููุน</th>
                                <th>ุงููุฒู (ุบ)</th>
                                <th>ุงูุณุนุฑ</th>
                                <th>ุงููุฏููุน</th>
                                <th>ุงููุชุจูู</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(record => {
                                const date = new Date(record.date);
                                const dateStr = date.toLocaleDateString('ar-DZ', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit'
                                });
                                const customerName = record.firstName + ' ' + record.lastName;
                                const totalPaid = getTotalPaid(record);
                                const due = record.price - totalPaid;
                                const isCreditOnly = record.isCreditOnly === true;
                                const rowClass = due > 0 ? 'debt-row' : 'paid-row';
                                
                                return `
                                    <tr class="${rowClass}">
                                        <td>${dateStr}</td>
                                        <td>${customerName}</td>
                                        <td>${record.phoneNumber || '-'}</td>
                                        <td>${record.idNumber}</td>
                                        <td>${isCreditOnly ? 'ุฏูู ููุท' : 'ุจูุน'}</td>
                                        <td>${record.grams > 0 ? record.grams.toFixed(2) : '-'}</td>
                                        <td>${formatCurrency(record.price)}</td>
                                        <td>${formatCurrency(totalPaid)}</td>
                                        <td class="${due > 0 ? 'debt-text' : 'paid-text'}">${formatCurrency(due)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>ุฎุฒูุฉ ูุจูุนุงุช ุงูุฐูุจ ุงููุดูุฑุฉ</strong></p>
                        <p>ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ูู ${new Date().toLocaleString('ar-DZ')}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 500);
        });



        // Lock functionality
        document.getElementById('lockBtn').addEventListener('click', () => {
            if (confirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
                sessionStorage.removeItem('vault_pass');
                window.location.href = 'index.html';
            }
        });

        // Search functionality for Sales
        let currentSalesFilter = '';
        document.getElementById('salesSearchInput').addEventListener('input', (e) => {
            currentSalesFilter = e.target.value.toLowerCase().trim();
            renderTable();
        });

        // Search functionality for Clients
        let currentClientsFilter = '';
        document.getElementById('clientsSearchInput').addEventListener('input', (e) => {
            currentClientsFilter = e.target.value.toLowerCase().trim();
            renderClientsList();
        });

        // Search functionality for Credits
        let currentCreditsFilter = '';
        document.getElementById('creditsSearchInput').addEventListener('input', (e) => {
            currentCreditsFilter = e.target.value.toLowerCase().trim();
            renderCreditClients();
        });

        // Search functionality for Savings
        let currentSavingsFilter = '';
        document.getElementById('savingsSearchInput').addEventListener('input', (e) => {
            currentSavingsFilter = e.target.value.toLowerCase().trim();
            renderSavingsClients();
        });

        // Savings form submission
        document.getElementById('savingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Generate unique ID if not provided
            const savingsIdNumber = formData.get('savingsIdNumber').trim() || `AUTO_${Date.now()}`;
            const savingsPhoneNumber = formData.get('savingsPhoneNumber').trim() || '';
            const savingsAmount = parseFloat(formData.get('savingsAmount'));
            
            const newRecord = {
                id: Date.now().toString(),
                firstName: formData.get('savingsFirstName').trim(),
                lastName: formData.get('savingsLastName').trim(),
                idNumber: savingsIdNumber,
                phoneNumber: savingsPhoneNumber,
                grams: 0,
                price: 0,
                paid: -savingsAmount, // Negative = customer has credit with us
                date: new Date().toISOString(),
                payments: [],
                note: formData.get('savingsGoal').trim() || '',
                isSavings: true, // Mark as savings entry
                employee: sessionStorage.getItem('user_role') === 'employee' ? 
                         JSON.parse(sessionStorage.getItem('employee_data') || '{}').name : undefined
            };
            
            // Prepend to records
            records.unshift(newRecord);
            
            // Save
            try {
                await saveData();
                renderDashboard();
                renderTable();
                renderClientsList();
                renderCreditClients();
                renderSavingsClients();
                e.target.reset();
                document.getElementById('savingsFirstName').focus();
                
                alert(`ุชู ุฅุถุงูุฉ ุงููุฏุฎุฑุงุช ุจูุฌุงุญ! โ\n\nุงูุนููู: ${newRecord.firstName} ${newRecord.lastName}\nุงููุจูุบ ุงููุฏุฎุฑ: ${formatCurrency(savingsAmount)}\n${newRecord.note ? 'ุงููุฏู: ' + newRecord.note : ''}`);
            } catch (error) {
                alert('ูุดู ุญูุธ ุงูุจูุงูุงุช. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
            }
        });

        // Render savings clients
        function renderSavingsClients() {
            const container = document.getElementById('savingsClientsContainer');
            
            // Filter only savings records (where paid is negative = they have credit with us)
            let savingsRecords = records.filter(r => r.isSavings === true || r.paid < 0);
            
            // Group by client
            const clientsMap = new Map();
            
            savingsRecords.forEach(record => {
                const clientKey = record.idNumber;
                if (!clientsMap.has(clientKey)) {
                    clientsMap.set(clientKey, {
                        firstName: record.firstName,
                        lastName: record.lastName,
                        idNumber: record.idNumber,
                        phoneNumber: record.phoneNumber,
                        transactions: [],
                        totalSaved: 0,
                        goal: record.note
                    });
                }
                
                const client = clientsMap.get(clientKey);
                const totalPaid = getTotalPaid(record);
                const savings = -totalPaid; // Negative means they have credit
                
                if (savings > 0) {
                    client.transactions.push(record);
                    client.totalSaved += savings;
                    if (record.note && !client.goal) {
                        client.goal = record.note;
                    }
                }
            });
            
            if (clientsMap.size === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุฏุฎุฑุงุช ูุณุฌูุฉ</p>';
                return;
            }
            
            let clientsArray = Array.from(clientsMap.values()).sort((a, b) => b.totalSaved - a.totalSaved);
            
            // Filter based on search
            if (currentSavingsFilter) {
                clientsArray = clientsArray.filter(client => {
                    const fullName = `${client.firstName} ${client.lastName}`.toLowerCase();
                    const phone = (client.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentSavingsFilter) || phone.includes(currentSavingsFilter);
                });
            }
            
            if (clientsArray.length === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="clients-grid">
                    ${clientsArray.map(client => {
                        const customerName = `${client.firstName} ${client.lastName}`;
                        
                        return `
                            <div class="client-card" style="border-right: 4px solid #16a34a;">
                                <div class="client-header">
                                    <div class="client-avatar" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);">
                                        ${client.firstName.charAt(0)}${client.lastName.charAt(0)}
                                    </div>
                                    <div>
                                        <h3 class="client-name">${customerName}</h3>
                                        <p class="client-id">ุฑูู ุงููููุฉ: ${client.idNumber}</p>
                                        ${client.phoneNumber ? `<p class="client-phone">๐ฑ ${client.phoneNumber}</p>` : ''}
                                    </div>
                                </div>
                                ${client.goal ? `
                                    <div style="background: #f0fdf4; padding: 0.75rem; border-radius: 8px; margin: 1rem 0;">
                                        <span style="color: #15803d; font-weight: 600;">๐ ุงููุฏู:</span>
                                        <span style="color: #166534; margin-right: 0.5rem;">${client.goal}</span>
                                    </div>
                                ` : ''}
                                <div class="client-stats">
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุนุฏุฏ ุงูุฏูุนุงุช</span>
                                        <span class="client-stat-value">${client.transactions.length}</span>
                                    </div>
                                    <div class="client-stat">
                                        <span class="client-stat-label">ุงููุจูุบ ุงููุฏุฎุฑ</span>
                                        <span class="client-stat-value" style="color: #16a34a; font-size: 1.5rem; font-weight: 700;">
                                            ${formatCurrency(client.totalSaved)}
                                        </span>
                                    </div>
                                </div>
                                <button onclick="withdrawSavings('${client.idNumber}')" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                                    ๐ฐ ุงุณุชุฎุฏุงู ุงููุฏุฎุฑุงุช ููุดุฑุงุก
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Withdraw savings (convert to sale)
        window.withdrawSavings = function(idNumber) {
            const client = records.find(r => r.idNumber === idNumber && (r.isSavings === true || r.paid < 0));
            if (!client) return;
            
            const customerName = `${client.firstName} ${client.lastName}`;
            const totalSaved = -getTotalPaid(client);
            
            const message = `ุงุณุชุฎุฏุงู ูุฏุฎุฑุงุช ${customerName}ุ\n\nุงููุจูุบ ุงููุฏุฎุฑ: ${formatCurrency(totalSaved)}\n\nุณูุชู ูููู ุฅูู ุชุจููุจ ุงููุจูุนุงุช ูุฅุชูุงู ุนูููุฉ ุงูุดุฑุงุก.\nููููู ุงุณุชุฎุฏุงู ุงููุจูุบ ุงููุฏุฎุฑ ูุฏูุนุฉ.`;
            
            if (confirm(message)) {
                // Switch to sales tab
                document.querySelector('[data-tab="sales"]').click();
                
                // Pre-fill the form
                document.getElementById('firstName').value = client.firstName;
                document.getElementById('lastName').value = client.lastName;
                document.getElementById('idNumber').value = client.idNumber;
                document.getElementById('phoneNumber').value = client.phoneNumber || '';
                document.getElementById('paid').value = totalSaved;
                
                // Focus on grams field
                document.getElementById('grams').focus();
                
                alert(`โ ุชู ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุนููู!\n\nุงููุจูุบ ุงููุฏุฎุฑ (${formatCurrency(totalSaved)}) ุชู ุฅุฏุฑุงุฌู ููุจูุบ ูุฏููุน.\n\nุฃุฏุฎู ุงูุขู ูุฒู ุงูุฐูุจ ูุงูุณุนุฑ ุงูุฅุฌูุงูู ูุฅุชูุงู ุงูุจูุน.`);
            }
        };

        // Show period details
        window.showPeriodDetails = function(days) {
            const now = new Date();
            const periodStart = new Date(now - days * 24 * 60 * 60 * 1000);
            
            // Filter records for this period
            const periodRecords = records.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate >= periodStart;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Filter purchases for this period
            const periodPurchases = purchases.filter(p => {
                const purchaseDate = new Date(p.date);
                return purchaseDate >= periodStart;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (periodRecords.length === 0 && periodPurchases.length === 0) {
                alert('ูุง ุชูุฌุฏ ุนูููุงุช ูู ูุฐู ุงููุชุฑุฉ');
                return;
            }
            
            // Calculate totals
            let totalRevenue = 0;
            let totalDebt = 0;
            let totalGrams = 0;
            let totalPurchasedGrams = 0;
            let totalPurchasedAmount = 0;
            
            periodRecords.forEach(record => {
                const totalPaid = getTotalPaid(record);
                const debt = record.price - totalPaid;
                
                if (totalPaid >= 0) {
                    totalRevenue += totalPaid;
                    totalDebt += debt;
                }
                totalGrams += record.grams;
            });
            
            periodPurchases.forEach(purchase => {
                totalPurchasedGrams += purchase.grams;
                totalPurchasedAmount += purchase.price;
            });
            
            // Update modal title
            const periodName = days === 1 ? 'ุขุฎุฑ 24 ุณุงุนุฉ' : days === 7 ? 'ุขุฎุฑ 7 ุฃูุงู' : days === 14 ? 'ุขุฎุฑ 14 ููู' : 'ุขุฎุฑ 30 ููู';
            document.getElementById('periodDetailsTitle').textContent = `๐ ุชูุงุตูู ${periodName}`;
            
            // Update summary cards
            document.getElementById('periodTotalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('periodTotalDebt').textContent = formatCurrency(totalDebt);
            document.getElementById('periodTotalGrams').textContent = totalGrams.toFixed(2) + ' ุบ';
            document.getElementById('periodTotalPurchased').textContent = totalPurchasedGrams.toFixed(2) + ' ุบ';
            
            // Build table
            const tableHTML = `
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูุนููู</th>
                            <th>ุฑูู ุงููููุฉ</th>
                            <th>ุงููุฒู (ุบ)</th>
                            <th>ุงูุณุนุฑ</th>
                            <th>ุงููุฏููุน</th>
                            <th>ุงููุชุจูู</th>
                            <th>ุงูุญุงูุฉ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${periodRecords.map(record => {
                            const date = new Date(record.date);
                            const dateStr = date.toLocaleDateString('ar-DZ', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            const customerName = `${record.firstName} ${record.lastName}`;
                            const totalPaid = getTotalPaid(record);
                            const due = record.price - totalPaid;
                            const hasPaidFully = due <= 0;
                            const isCreditOnly = record.isCreditOnly === true;
                            
                            return `
                                <tr class="${isCreditOnly ? 'credit-only-row' : ''}">
                                    <td>${dateStr}</td>
                                    <td>
                                        ${customerName}
                                        ${record.employee ? '<br><span class="badge" style="background: #7c3aed; font-size: 0.75rem;">๐ค ' + record.employee + '</span>' : ''}
                                        ${record.phoneNumber ? '<br><small style="color: #0c8599;">๐ฑ ' + record.phoneNumber + '</small>' : ''}
                                    </td>
                                    <td>${record.idNumber}</td>
                                    <td>${record.grams > 0 ? record.grams.toFixed(2) : '-'}</td>
                                    <td>${formatCurrency(record.price)}</td>
                                    <td>${formatCurrency(totalPaid)}</td>
                                    <td class="${due > 0 ? 'due-amount' : 'paid-full'}">${formatCurrency(due)}</td>
                                    <td>
                                        ${hasPaidFully 
                                            ? '<span class="badge badge-success">ูุฏููุน โ</span>' 
                                            : `<span class="badge badge-warning">ุฏูู</span>`
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Add purchases table if there are any
            if (periodPurchases.length > 0) {
                tableHTML += `
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                        <h3 style="color: #059669; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>๐</span>
                            <span>ุนูููุงุช ุดุฑุงุก ุงูุฐูุจ (ูู ุงูุนููุงุก)</span>
                        </h3>
                        <table class="sales-table">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงูุนููู</th>
                                    <th>ุฑูู ุงููููุฉ</th>
                                    <th>ุงููุฒู (ุบ)</th>
                                    <th>ุงูุณุนุฑ ุงููุชูู</th>
                                    <th>ุงููุฏููุน</th>
                                    <th>ุงููุชุจูู</th>
                                    <th>ุงูุญุงูุฉ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${periodPurchases.map(purchase => {
                                    const date = new Date(purchase.date);
                                    const dateStr = date.toLocaleDateString('ar-DZ', {
                                        year: 'numeric',
                                        month: '2-digit',
                                        day: '2-digit',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    });
                                    const customerName = `${purchase.firstName} ${purchase.lastName}`;
                                    const remaining = purchase.remaining || 0;
                                    const hasPaidFully = remaining <= 0;
                                    
                                    return `
                                        <tr style="background: rgba(5, 150, 105, 0.05);">
                                            <td>${dateStr}</td>
                                            <td>
                                                ${customerName}
                                                ${purchase.employee ? '<br><span class="badge" style="background: #7c3aed; font-size: 0.75rem;">๐ค ' + purchase.employee + '</span>' : ''}
                                                ${purchase.phoneNumber ? '<br><small style="color: #059669;">๐ฑ ' + purchase.phoneNumber + '</small>' : ''}
                                            </td>
                                            <td>${purchase.idNumber}</td>
                                            <td style="color: #059669; font-weight: 600;">${purchase.grams.toFixed(2)}</td>
                                            <td>${formatCurrency(purchase.price)}</td>
                                            <td style="color: #059669;">${formatCurrency(purchase.paid)}</td>
                                            <td class="${remaining > 0 ? 'due-amount' : 'paid-full'}">${formatCurrency(remaining)}</td>
                                            <td>
                                                ${hasPaidFully 
                                                    ? '<span class="badge badge-success">ูุฏููุน ูุงููุง โ</span>' 
                                                    : `<span class="badge badge-warning">ูุชุจูู ููุฏูุน</span>`
                                                }
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('periodDetailsTable').innerHTML = tableHTML;
            document.getElementById('periodDetailsModal').style.display = 'flex';
        };

        // Close period details modal
        window.closePeriodDetailsModal = function() {
            document.getElementById('periodDetailsModal').style.display = 'none';
        };

        // Save purchases to localStorage
        function savePurchases() {
            try {
                localStorage.setItem('gold_purchases', JSON.stringify(purchases));
            } catch (error) {
                console.error('Failed to save purchases:', error);
                alert('ูุดู ุญูุธ ุจูุงูุงุช ุงููุดุชุฑูุงุช');
            }
        }

        // Purchase form submission
        document.getElementById('purchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            const purchaseIdNumber = formData.get('purchaseIdNumber').trim() || `AUTO_${Date.now()}`;
            const purchasePhoneNumber = formData.get('purchasePhoneNumber').trim();
            const purchaseGrams = parseFloat(formData.get('purchaseGrams'));
            const purchasePrice = parseFloat(formData.get('purchasePrice'));
            const purchasePaid = parseFloat(formData.get('purchasePaid'));
            
            if (purchasePaid > purchasePrice) {
                alert('ุงููุจูุบ ุงููุฏููุน ูุง ูููู ุฃู ูููู ุฃูุจุฑ ูู ุงูุณุนุฑ ุงููุชูู ุนููู');
                return;
            }
            
            const newPurchase = {
                id: Date.now().toString(),
                firstName: formData.get('purchaseFirstName').trim(),
                lastName: formData.get('purchaseLastName').trim(),
                idNumber: purchaseIdNumber,
                phoneNumber: purchasePhoneNumber,
                grams: purchaseGrams,
                price: purchasePrice,
                paid: purchasePaid,
                remaining: purchasePrice - purchasePaid,
                date: new Date().toISOString(),
                note: formData.get('purchaseNote').trim(),
                employee: sessionStorage.getItem('user_role') === 'employee' ? 
                         JSON.parse(sessionStorage.getItem('employee_data') || '{}').name : undefined
            };
            
            purchases.unshift(newPurchase);
            savePurchases();
            renderPurchasesList();
            
            e.target.reset();
            document.getElementById('purchaseFirstName').focus();
            
            const customerName = `${newPurchase.firstName} ${newPurchase.lastName}`;
            const remainingAmount = newPurchase.remaining;
            
            alert(`ุชู ุชุณุฌูู ุงูุดุฑุงุก ุจูุฌุงุญ! โ\n\nุงูุนููู: ${customerName}\nุงููุฒู: ${purchaseGrams} ุบุฑุงู\nุงูุณุนุฑ: ${formatCurrency(purchasePrice)}\nุงููุฏููุน: ${formatCurrency(purchasePaid)}\n${remainingAmount > 0 ? 'ุงููุชุจูู: ' + formatCurrency(remainingAmount) : 'ูุฏููุน ุจุงููุงูู โ'}`);
        });

        // Search functionality for Purchases
        let currentPurchasesFilter = '';
        document.getElementById('purchasesSearchInput').addEventListener('input', (e) => {
            currentPurchasesFilter = e.target.value.toLowerCase().trim();
            renderPurchasesList();
        });

        // Render purchases list
        function renderPurchasesList() {
            const container = document.getElementById('purchasesListContainer');
            
            if (purchases.length === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุดุชุฑูุงุช ูุณุฌูุฉ</p>';
                return;
            }
            
            let filteredPurchases = purchases;
            
            // Apply search filter
            if (currentPurchasesFilter) {
                filteredPurchases = purchases.filter(purchase => {
                    const fullName = `${purchase.firstName} ${purchase.lastName}`.toLowerCase();
                    const phone = (purchase.phoneNumber || '').toLowerCase();
                    return fullName.includes(currentPurchasesFilter) || phone.includes(currentPurchasesFilter);
                });
            }
            
            if (filteredPurchases.length === 0) {
                container.innerHTML = '<p class="empty-message">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'sales-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุนููู</th>
                        <th>ุฑูู ุงููููุฉ</th>
                        <th>ุงููุฒู (ุบ)</th>
                        <th>ุงูุณุนุฑ ุงููุชูู</th>
                        <th>ุงููุฏููุน</th>
                        <th>ุงููุชุจูู</th>
                        <th>ุงูุญุงูุฉ</th>
                        <th>ููุงุญุธุฉ</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredPurchases.map(purchase => {
                        const date = new Date(purchase.date);
                        const dateStr = date.toLocaleDateString('ar-DZ', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const customerName = `${purchase.firstName} ${purchase.lastName}`;
                        const hasPaidFully = purchase.remaining <= 0;
                        
                        return `
                            <tr style="background: ${hasPaidFully ? '#f0fdf4' : '#fff7ed'};">
                                <td>${dateStr}</td>
                                <td>
                                    ${customerName}
                                    ${purchase.employee ? '<br><span class="badge" style="background: #7c3aed; font-size: 0.75rem;">๐ค ' + purchase.employee + '</span>' : ''}
                                    ${purchase.phoneNumber ? '<br><small style="color: #0c8599;">๐ฑ ' + purchase.phoneNumber + '</small>' : ''}
                                </td>
                                <td>${purchase.idNumber}</td>
                                <td style="font-weight: 600; color: #0891b2;">${purchase.grams.toFixed(2)}</td>
                                <td>${formatCurrency(purchase.price)}</td>
                                <td>${formatCurrency(purchase.paid)}</td>
                                <td class="${purchase.remaining > 0 ? 'due-amount' : 'paid-full'}">${formatCurrency(purchase.remaining)}</td>
                                <td>
                                    ${hasPaidFully 
                                        ? '<span class="badge badge-success">ูุฏููุน โ</span>' 
                                        : '<span class="badge badge-warning">ูุชุจูู</span>'
                                    }
                                </td>
                                <td>${purchase.note || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Initialize
        loadData();
    </script>
</body>
</html>
