<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø²Ù†Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ”’ Ø®Ø²Ù†Ø© Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø°Ù‡Ø¨</h1>
            <p class="subtitle">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
            
            <!-- Role Selection -->
            <div id="roleSelection" class="role-selection">
                <button type="button" class="role-btn" data-role="admin">
                    <div class="role-icon">ğŸ‘‘</div>
                    <div class="role-title">Ø§Ù„Ù…Ø¯ÙŠØ±</div>
                    <div class="role-desc">Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                </button>
                <button type="button" class="role-btn" data-role="employee">
                    <div class="role-icon">ğŸ‘¤</div>
                    <div class="role-title">Ù…ÙˆØ¸Ù</div>
                    <div class="role-desc">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙ‚Ø·</div>
                </button>
            </div>
            
            <!-- Admin Login Form -->
            <form id="adminLoginForm" style="display: none;">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ‘‘</h2>
                <div class="form-group">
                    <label for="adminPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</label>
                    <input 
                        type="password" 
                        id="adminPassword" 
                        name="adminPassword"
                        required 
                        autocomplete="current-password"
                        placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
                    >
                </div>
                
                <div id="adminErrorMessage" class="error-message" style="display: none;"></div>
                <div id="adminLockoutMessage" class="error-message" style="display: none;"></div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" id="adminLoginButton" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
                    <button type="button" id="backFromAdmin" class="btn btn-secondary">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </form>
            
            <!-- Employee Login Form -->
            <form id="employeeLoginForm" style="display: none;">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸Ù ğŸ‘¤</h2>
                <div class="form-group">
                    <label for="employeeName">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <input 
                        type="text" 
                        id="employeeName" 
                        name="employeeName"
                        required 
                        placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"
                    >
                </div>
                <div class="form-group">
                    <label for="employeePassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input 
                        type="password" 
                        id="employeePassword" 
                        name="employeePassword"
                        required 
                        placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù"
                    >
                </div>
                
                <div id="employeeErrorMessage" class="error-message" style="display: none;"></div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" id="employeeLoginButton" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
                    <button type="button" id="backFromEmployee" class="btn btn-secondary">Ø±Ø¬ÙˆØ¹</button>
                </div>
            </form>
            
            <div class="info-box">
                <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ù†ÙŠØ©:</strong></p>
                <ul>
                    <li>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø£Ø¨Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…</li>
                    <li>Ø¥Ø°Ø§ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                    <li>ÙŠØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø¯Ø© 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø©</li>
                    <li>Ø§Ø­ØªÙØ¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { canEnterNow, registerAttempt, lockInfo } from './app.js';
        import { encryptJSON, decryptJSON } from './crypto.js';

        // Get employee password from config (in real app, this should be in encrypted config)
        const EMPLOYEE_PASSWORD = 'employee123'; // You can change this!

        // Elements
        const roleSelection = document.getElementById('roleSelection');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const employeeLoginForm = document.getElementById('employeeLoginForm');
        const backFromAdmin = document.getElementById('backFromAdmin');
        const backFromEmployee = document.getElementById('backFromEmployee');

        // Role selection
        document.querySelectorAll('.role-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const role = btn.dataset.role;
                roleSelection.style.display = 'none';
                
                if (role === 'admin') {
                    adminLoginForm.style.display = 'block';
                    document.getElementById('adminPassword').focus();
                } else {
                    employeeLoginForm.style.display = 'block';
                    document.getElementById('employeeName').focus();
                }
            });
        });

        // Back buttons
        backFromAdmin.addEventListener('click', () => {
            adminLoginForm.style.display = 'none';
            roleSelection.style.display = 'grid';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminErrorMessage').style.display = 'none';
        });

        backFromEmployee.addEventListener('click', () => {
            employeeLoginForm.style.display = 'none';
            roleSelection.style.display = 'grid';
            document.getElementById('employeeName').value = '';
            document.getElementById('employeePassword').value = '';
            document.getElementById('employeeErrorMessage').style.display = 'none';
        });

        // Check admin lockout status
        function updateAdminLockoutUI() {
            const canEnter = canEnterNow();
            const adminLoginButton = document.getElementById('adminLoginButton');
            const adminPasswordInput = document.getElementById('adminPassword');
            const adminErrorMessage = document.getElementById('adminErrorMessage');
            const adminLockoutMessage = document.getElementById('adminLockoutMessage');
            
            if (!canEnter) {
                const info = lockInfo();
                adminLoginButton.disabled = true;
                adminPasswordInput.disabled = true;
                adminLockoutMessage.style.display = 'block';
                adminLockoutMessage.textContent = `ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©: ${info.attempts}. Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${info.minutesLeft} Ø¯Ù‚ÙŠÙ‚Ø©.`;
                adminErrorMessage.style.display = 'none';
                
                setTimeout(updateAdminLockoutUI, 60000);
            } else {
                adminLoginButton.disabled = false;
                adminPasswordInput.disabled = false;
                adminLockoutMessage.style.display = 'none';
                
                const info = lockInfo();
                if (info.attempts > 0) {
                    adminErrorMessage.style.display = 'block';
                    adminErrorMessage.textContent = `ØªØ­Ø°ÙŠØ±: ${info.attempts} Ù…Ø­Ø§ÙˆÙ„Ø© ÙØ§Ø´Ù„Ø©. Ø³ÙŠØªÙ… Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ ${5 - info.attempts} Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©.`;
                }
            }
        }

        updateAdminLockoutUI();

        // Admin login
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!canEnterNow()) {
                return;
            }
            
            const password = document.getElementById('adminPassword').value.trim();
            const adminErrorMessage = document.getElementById('adminErrorMessage');
            const adminLoginButton = document.getElementById('adminLoginButton');
            
            if (!password) {
                adminErrorMessage.style.display = 'block';
                adminErrorMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±';
                return;
            }
            
            adminLoginButton.disabled = true;
            adminLoginButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            adminErrorMessage.style.display = 'none';
            
            try {
                if (!window.crypto || !window.crypto.subtle) {
                    throw new Error('Web Crypto API not supported');
                }
                
                // Store admin password
                sessionStorage.setItem('vault_pass', password);
                sessionStorage.setItem('user_role', 'admin');
                
                registerAttempt(true);
                window.location.href = './sales.html';
                
            } catch (error) {
                console.error('Admin login error:', error.message);
                registerAttempt(false);
                updateAdminLockoutUI();
                
                if (canEnterNow()) {
                    adminErrorMessage.style.display = 'block';
                    const info = lockInfo();
                    adminErrorMessage.textContent = info.attempts === 0 
                        ? 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
                        : `ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©: ${info.attempts}/5`;
                }
                
                adminLoginButton.disabled = false;
                adminLoginButton.textContent = 'Ø¯Ø®ÙˆÙ„';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        });

        // Employee login
        employeeLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const employeeName = document.getElementById('employeeName').value.trim();
            const employeePassword = document.getElementById('employeePassword').value.trim();
            const employeeErrorMessage = document.getElementById('employeeErrorMessage');
            const employeeLoginButton = document.getElementById('employeeLoginButton');
            
            if (!employeeName || !employeePassword) {
                employeeErrorMessage.style.display = 'block';
                employeeErrorMessage.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                return;
            }
            
            employeeLoginButton.disabled = true;
            employeeLoginButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
            employeeErrorMessage.style.display = 'none';
            
            try {
                // Check employee password
                if (employeePassword !== EMPLOYEE_PASSWORD) {
                    throw new Error('Invalid employee password');
                }
                
                // Store employee data (need admin password to save data)
                const adminPassword = prompt('ÙŠØ±Ø¬Ù‰ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù:');
                
                if (!adminPassword) {
                    throw new Error('Admin password required');
                }
                
                // Verify admin password works
                try {
                    await crypto.subtle.importKey(
                        'raw',
                        new TextEncoder().encode(adminPassword),
                        { name: 'PBKDF2' },
                        false,
                        ['deriveBits', 'deriveKey']
                    );
                } catch {
                    throw new Error('Invalid admin password');
                }
                
                // Store session data
                sessionStorage.setItem('vault_pass', adminPassword);
                sessionStorage.setItem('user_role', 'employee');
                sessionStorage.setItem('employee_data', JSON.stringify({
                    name: employeeName
                }));
                
                window.location.href = './employee.html';
                
            } catch (error) {
                console.error('Employee login error:', error.message);
                
                employeeErrorMessage.style.display = 'block';
                if (error.message === 'Invalid employee password') {
                    employeeErrorMessage.textContent = 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                } else if (error.message === 'Admin password required') {
                    employeeErrorMessage.textContent = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
                } else if (error.message === 'Invalid admin password') {
                    employeeErrorMessage.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                } else {
                    employeeErrorMessage.textContent = 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                }
                
                employeeLoginButton.disabled = false;
                employeeLoginButton.textContent = 'Ø¯Ø®ÙˆÙ„';
            }
        });
    </script>
</body>
</html>
